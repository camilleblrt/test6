var shaderSuperBlaze_Corevs = "precision mediump float;\n\nattribute vec3 aVertexPosition;\nattribute vec3 aNormal;\nattribute vec2 aTextureCoord;\n\nuniform vec3 uCamPos;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat4 uOMatrix;\nuniform vec2 jitter;\n\nvarying vec2 tex1;\n\nvarying vec3 g_norm;\nvarying vec3 eyeDir;\n\n#if hasBumpTexture\nattribute vec3 aSurfTanU;\nattribute vec3 aSurfTanV;\nvarying vec3 bu;\nvarying vec3 bv;\n#endif\n\nvoid main(void)\n{\nvec4 vPosition = uOMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = uPMatrix * uMVMatrix * vPosition;\ngl_Position.xy += jitter * gl_Position.w;\n\ntex1 = aTextureCoord;\n\ng_norm = normalize(uOMatrix * vec4(aNormal,0.0)).xyz;\n\neyeDir = vPosition.xyz - uCamPos;\n\n#if hasBumpTexture\nbu = aSurfTanU;\nbv = aSurfTanV;\n#endif\n}\n";var shaderSuperBlaze_Corefs = "precision mediump float;\n\n#if hasDiffuseEnv\nuniform samplerCube diffuseenv;\nuniform vec2 diffusecachescaleoffset;\n#endif\n#if hasDiffuseTexture\nuniform sampler2D diffusetexture;\nuniform float diffusetextureuvscale;\n#endif\nuniform vec3 diffusecolor;\n\nuniform samplerCube glossyenv;\nuniform vec2 glossycachescaleoffset;\n#if hasGlossyTexture\nuniform sampler2D glossytexture;\nuniform float glossytextureuvscale;\n#endif\nuniform vec3 glossycolor;\n\nuniform samplerCube specularenv;\nuniform vec2 specularcachescaleoffset;\n#if hasSpecularTexture\nuniform sampler2D speculartexture;\nuniform float speculartextureuvscale;\n#endif\nuniform vec3 specularcolor;\n\nuniform int fresnel;\nuniform float degree_0_specular;\nuniform float degree_90_specular;\nuniform float brdf_curve;\n\n#if hasAlphaTexture\nuniform sampler2D alphatexture;\nuniform float alphatextureuvscale;\n#endif\n\n#if hasBumpTexture\nuniform sampler2D bumptexture;\nuniform float bumpuserscale;\nvarying vec3 bu;\nvarying vec3 bv;\n#endif\n\nuniform float invertreflectiony;\n\nvarying vec2 tex1;\nvarying vec3 g_norm;\nvarying vec3 eyeDir;\n\nvoid main(void)\n{\nvec3 reflectDir;\nvec3 neyeDir = normalize(eyeDir);\n\nvec3 ngnorm = g_norm;\n#if hasBumpTexture\nvec3 bumpValue = (texture2D(bumptexture, tex1).xyz-0.498039)*2.0;\nbumpValue *= bumpuserscale;\nngnorm += bumpValue.z * bu;\nngnorm += bumpValue.y * bv;\nngnorm = normalize(ngnorm);\n#endif\n\nreflectDir = reflect(neyeDir, ngnorm);\nreflectDir = normalize(reflectDir);\nreflectDir.y *= invertreflectiony;\n\n\n\n\nvec4 diffuseSum = vec4(diffusecolor, 1.0);\n#if hasDiffuseEnv\ndiffuseSum *= diffusecachescaleoffset.x*textureCube(diffuseenv, reflectDir)+diffusecachescaleoffset.y;\n#endif\n#if hasDiffuseTexture\ndiffuseSum *= texture2D(diffusetexture, diffusetextureuvscale*tex1);\n#endif\n\n\nvec4 glossySum = glossycachescaleoffset.x*textureCube(glossyenv, reflectDir)+glossycachescaleoffset.y;\nglossySum *= vec4(glossycolor, 1.0);\n#if hasGlossyTexture\nglossySum *= texture2D(glossytexture, glossytextureuvscale*tex1);\n#endif\n\n\nvec4 specularSum = specularcachescaleoffset.x*textureCube(specularenv, reflectDir)+specularcachescaleoffset.y;\nspecularSum *= vec4(specularcolor, 1.0);\n#if hasSpecularTexture\nspecularSum *= texture2D(speculartexture, speculartextureuvscale*tex1);\n#endif\n\n\nif (fresnel != 0)\n{\nfloat dotnd = dot(neyeDir, ngnorm);\nif (dotnd > 0.0)\ndotnd = -dotnd;\nfloat fresnelFactor = pow(acos(-dotnd) / (3.14159625*0.5), brdf_curve);\nfresnelFactor = (fresnelFactor*degree_90_specular) + ((1.0-fresnelFactor)*degree_0_specular);\ndiffuseSum *= (1.0 - fresnelFactor);\nglossySum *= (1.0 - fresnelFactor);\nspecularSum *= fresnelFactor;\n}\n\ngl_FragColor = diffuseSum + glossySum + specularSum;\n\n\n#if hasAlphaTexture\ngl_FragColor.a = texture2D(alphatexture, alphatextureuvscale*tex1).x;\n#endif\n}\n";var shaderSuperBlaze_Glassfs = "precision mediump float;\n\nuniform samplerCube specularenv;\nuniform vec2 specularcachescaleoffset;\n#if hasSpecularTexture\nuniform sampler2D speculartexture;\nuniform float speculartextureuvscale;\n#endif\nuniform vec3 specularcolor;\n\n#if hasBaseTexture\nuniform sampler2D basetexture;\n#endif\nuniform vec3 basecolor;\n\n#if hasBumpTexture\nuniform sampler2D bumptexture;\nuniform float bumpuserscale;\nvarying vec3 bu;\nvarying vec3 bv;\n#endif\n\nuniform float degree_0_specular;\nuniform float degree_90_specular;\nuniform float brdf_curve;\n\nvarying vec2 tex1;\nvarying vec3 g_norm;\nvarying vec3 eyeDir;\n\n\n\nvoid main()\n{\nvec3 reflectDir;\nvec3 neyeDir = normalize(eyeDir);\n\nvec3 ngnorm = g_norm;\n#if hasBumpTexture\nvec3 bumpValue = (texture2D(bumptexture, tex1).xyz-0.498039)*2.0;\nbumpValue *= bumpuserscale;\nngnorm += bumpValue.z * bu;\nngnorm += bumpValue.y * bv;\nngnorm = normalize(ngnorm);\n#endif\n\nreflectDir = reflect(neyeDir, ngnorm);\nreflectDir = normalize(reflectDir);\n\n\nvec4 specularSum = specularcachescaleoffset.x*textureCube(specularenv, reflectDir)+specularcachescaleoffset.y;\nvec4 specularScale = vec4(specularcolor, 1.0);\n#if hasSpecularTexture\nspecularScale *= texture2D(speculartexture, speculartextureuvscale*tex1);\n#endif\nspecularSum *= specularScale;\n\nvec4 baseScale = vec4(basecolor, 1.0);\n#if hasBaseTexture\nbaseScale *= texture2D(basetexture, tex1);\n#endif\nspecularSum += baseScale;\n\ngl_FragColor = specularSum;\n\n\nfloat dotnd = dot(neyeDir, ngnorm);\nif (dotnd > 0.0)\ndotnd = -dotnd;\nfloat angle = acos(-dotnd) / (3.14159625*0.5);\nfloat fresnelFactor = pow(angle, brdf_curve);\ngl_FragColor.a = (fresnelFactor*degree_90_specular) + ((1.0-fresnelFactor)*degree_0_specular);\n}\n";var shaderSuperBlaze_Ambientfs = "precision mediump float;\n\n#if hasDiffuseTexture\nuniform sampler2D diffusetexture;\nuniform float diffusetextureuvscale;\n#endif\nuniform vec3 diffusecolor;\n\nvarying vec2 tex1;\nvarying vec3 g_norm;\n\n\n\nvoid main()\n{\nvec4 ambientSum = vec4(diffusecolor, 1.0);\n#if hasDiffuseTexture\nambientSum *= texture2D(diffusetexture, diffusetextureuvscale*tex1);\n#endif\n\ngl_FragColor = ambientSum;\n}\n";var shaderSuperBlaze_Refinevs = "precision mediump float;\n\nattribute vec2 a_position;\nattribute vec2 a_tex0;\n\nvarying vec2 tex0;\n\nvoid main()\n{\ntex0 = a_tex0;\ngl_Position = vec4(a_position, 0.0, 1.0);\n}\n";var shaderSuperBlaze_Refinefs = "precision mediump float;\n\nvarying vec2 tex0;\n\nuniform sampler2D logoTex;\nuniform sampler2D prevTex;\nuniform int solidColor;\nuniform float solidAlpha;\n\nvoid main()\n{\nif (solidColor == 1)\ngl_FragColor = solidAlpha*texture2D(logoTex, tex0) + (1.0-solidAlpha)*texture2D(prevTex, tex0);\nelse if (solidColor == 0)\ngl_FragColor = vec4(texture2D(logoTex, tex0).xyz, solidAlpha);\nelse\ngl_FragColor = vec4(texture2D(logoTex, tex0).xyz, texture2D(logoTex, tex0).w*solidAlpha);\n}\n";var M_PI=3.141592653589793;var M_TWO_PI=2*M_PI;var M_HALF_PI=M_PI/2;var SHADER_TYPE_STANDARD=0;var SHADER_TYPE_GLASS=1;var SHADER_TYPE_AMBIENT=2;var SHADER_TYPE_MAX=3;var TEXTURE_MAP_ALPHATEX=0;var TEXTURE_MAP_DIFFUSETEX=1;var TEXTURE_MAP_DIFFUSEENV=2;var TEXTURE_MAP_GLOSSYTEX=3;var TEXTURE_MAP_GLOSSYENV=4;var TEXTURE_MAP_SPECULARTEX=5;var TEXTURE_MAP_SPECULARENV=6;var TEXTURE_MAP_BUMPTEX=7;var TEXTURE_MAP_BASETEX=8;var SHADER_DIFFUSETEX_MAP=1;var SHADER_DIFFUSEENV_MAP=2;var SHADER_GLOSSYTEX_MAP=4;var SHADER_GLOSSYENV_MAP=8;var SHADER_SPECULARTEX_MAP=16;var SHADER_SPECULARENV_MAP=32;var SHADER_ALPHA_MAP=64;var UNIFORM_TYPE_MATRIX=0;var UNIFORM_TYPE_VECTOR=1;var UNIFORM_TYPE_FLOAT=2;var UNIFORM_TYPE_ARRAY_VERTEX=3;var UNIFORM_TYPE_ARRAY_UV=4;var UNIFORM_TYPE_ARRAY_FLOAT=5;var UNIFORM_TYPE_INT=6;var UNIFORM_TYPE_FLOAT2=7;var FANIM_INTERPOLATION_STEP=0;var FANIM_INTERPOLATION_LINEAR=1;var FANIM_INTERPOLATION_BEZIER=2;var FANIM_INTERPOLATION_TCB=3;var FANIM_INFINITY_CONSTANT=0;var FANIM_INFINITY_LINEAR=1;var FANIM_INFINITY_CYCLE=2;var FANIM_INFINITY_CYCLE_RELATIVE=3;var FANIM_INFINITY_OSCILLATE=4;var superblaze_identity=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var _zNearMin=0.5;BinaryReader=function(a){this._buffer=a;this._pos=0};BinaryReader.prototype={readInt8:function(){return this._decodeInt(8,true)},readUInt8:function(){return this._decodeInt(8,false)},readInt16:function(){return this._decodeInt(16,true)},readUInt16:function(){return this._decodeInt(16,false)},readInt32:function(){return this._decodeInt(32,true)},readUInt32:function(){return this._decodeInt(32,false)},readFloat:function(){return this._decodeFloat(23,8)},readDouble:function(){return this._decodeFloat(52,11)},readChar:function(){return this.readString(1)},readString:function(b){this._checkSize(b*8);var a=this._buffer.substr(this._pos,b);this._pos+=b;return a},seek:function(a){this._pos=a;this._checkSize(0)},getPosition:function(){return this._pos},getSize:function(){return this._buffer.length},_decodeFloat:function(b,l){var d=b+l+1;var m=d>>3;this._checkSize(d);var f=Math.pow(2,l-1)-1;var i=this._readBits(b+l,1,m);var j=this._readBits(b,l,m);var h=0;var c=2;var a=0;do{var e=this._readByte(++a,m);var g=b%8||8;var k=1<<g;while(k>>=1){if(e&k){h+=1/c}c*=2}}while(b-=g);this._pos+=m;return j==(f<<1)+1?h?NaN:i?-Infinity:+Infinity:(1+i*-2)*(j||h?!j?Math.pow(2,-f+1)*h:Math.pow(2,j-f)*(1+h):0)},_decodeInt:function(e,d){var c=this._readBits(0,e,e/8),b=Math.pow(2,e);var a=d&&c>=b/2?c-b:c;this._pos+=e/8;return a},_shl:function(d,c){for(++c;--c;d=((d%=2147483647+1)&1073741824)==1073741824?d*2:(d-1073741824)*2+2147483647+1){}return d},_readByte:function(b,a){return this._buffer.charCodeAt(this._pos+a-b-1)&255},_readBits:function(b,c,i){var d=(b+c)%8;var e=b%8;var a=i-(b>>3)-1;var h=i+(-(b+c)>>3);var g=a-h;var f=(this._readByte(a,i)>>e)&((1<<(g?8-e:c))-1);if(g&&d){f+=(this._readByte(h++,i)&((1<<d)-1))<<(g--<<3)-e}while(g){f+=this._shl(this._readByte(h++,i),(g--<<3)-e)}return f},_checkSize:function(a){if(!(this._pos+Math.ceil(a/8)<this._buffer.length)){throw new Error("Index out of bound")}}};function MatrixMultiply(c,b){var a=Array();a[0]=c[0]*b[0]+c[1]*b[4]+c[2]*b[8]+c[3]*b[12];a[1]=c[0]*b[1]+c[1]*b[5]+c[2]*b[9]+c[3]*b[13];a[2]=c[0]*b[2]+c[1]*b[6]+c[2]*b[10]+c[3]*b[14];a[3]=c[0]*b[3]+c[1]*b[7]+c[2]*b[11]+c[3]*b[15];a[4]=c[4]*b[0]+c[5]*b[4]+c[6]*b[8]+c[7]*b[12];a[5]=c[4]*b[1]+c[5]*b[5]+c[6]*b[9]+c[7]*b[13];a[6]=c[4]*b[2]+c[5]*b[6]+c[6]*b[10]+c[7]*b[14];a[7]=c[4]*b[3]+c[5]*b[7]+c[6]*b[11]+c[7]*b[15];a[8]=c[8]*b[0]+c[9]*b[4]+c[10]*b[8]+c[11]*b[12];a[9]=c[8]*b[1]+c[9]*b[5]+c[10]*b[9]+c[11]*b[13];a[10]=c[8]*b[2]+c[9]*b[6]+c[10]*b[10]+c[11]*b[14];a[11]=c[8]*b[3]+c[9]*b[7]+c[10]*b[11]+c[11]*b[15];a[12]=c[12]*b[0]+c[13]*b[4]+c[14]*b[8]+c[15]*b[12];a[13]=c[12]*b[1]+c[13]*b[5]+c[14]*b[9]+c[15]*b[13];a[14]=c[12]*b[2]+c[13]*b[6]+c[14]*b[10]+c[15]*b[14];a[15]=c[12]*b[3]+c[13]*b[7]+c[14]*b[11]+c[15]*b[15];return a}function MatrixTranslation(d,c,b){var a=Array();a[0]=1;a[4]=0;a[8]=0;a[12]=d;a[1]=0;a[5]=1;a[9]=0;a[13]=c;a[2]=0;a[6]=0;a[10]=1;a[14]=b;a[3]=0;a[7]=0;a[11]=0;a[15]=1;return a}function MatrixScaling(d,c,b){var a=Array();a[0]=d;a[4]=0;a[8]=0;a[12]=0;a[1]=0;a[5]=c;a[9]=0;a[13]=0;a[2]=0;a[6]=0;a[10]=b;a[14]=0;a[3]=0;a[7]=0;a[11]=0;a[15]=1;return a}function MatrixRotationAxis(a,g,d,b){var k=Math.sin(a);var f=Math.cos(a);var i=g;var h=d;var e=b;var j=Array();j[0]=i*i*(1-f)+f;j[4]=i*h*(1-f)-(e*k);j[8]=i*e*(1-f)+(h*k);j[12]=0;j[1]=h*i*(1-f)+(e*k);j[5]=h*h*(1-f)+f;j[9]=h*e*(1-f)-(i*k);j[13]=0;j[2]=e*i*(1-f)-(h*k);j[6]=e*h*(1-f)+(i*k);j[10]=e*e*(1-f)+f;j[14]=0;j[3]=0;j[7]=0;j[11]=0;j[15]=1;return j}function MatrixDet(a){return(a)[3]*(a)[6]*(a)[9]*(a)[12]-(a)[2]*(a)[7]*a[9]*(a)[12]-(a)[3]*(a)[5]*(a)[10]*(a)[12]+(a)[1]*(a)[7]*(a)[10]*(a)[12]+(a)[2]*(a)[5]*(a)[11]*(a)[12]-(a)[1]*(a)[6]*(a)[11]*(a)[12]-(a)[3]*(a)[6]*(a)[8]*(a)[13]+(a)[2]*(a)[7]*(a)[8]*(a)[13]+(a)[3]*(a)[4]*(a)[10]*(a)[13]-(a)[0]*(a)[7]*(a)[10]*(a)[13]-(a)[2]*(a)[4]*(a)[11]*(a)[13]+(a)[0]*(a)[6]*(a)[11]*(a)[13]+(a)[3]*(a)[5]*(a)[8]*(a)[14]-(a)[1]*(a)[7]*(a)[8]*(a)[14]-(a)[3]*(a)[4]*(a)[9]*(a)[14]+(a)[0]*(a)[7]*(a)[9]*(a)[14]+(a)[1]*(a)[4]*(a)[11]*(a)[14]-(a)[0]*(a)[5]*(a)[11]*(a)[14]-(a)[2]*(a)[5]*(a)[8]*(a)[15]+(a)[1]*(a)[6]*(a)[8]*(a)[15]+(a)[2]*(a)[4]*(a)[9]*(a)[15]-(a)[0]*(a)[6]*(a)[9]*(a)[15]-(a)[1]*(a)[4]*(a)[10]*(a)[15]+(a)[0]*(a)[5]*(a)[10]*(a)[15]}function PointTransform(d,b){var a=d[0];var g=d[1];var f=d[2];var c=d[3];var e=Array();e[0]=a*b[0]+g*b[4]+f*b[8]+c*b[12];e[1]=a*b[1]+g*b[5]+f*b[9]+c*b[13];e[2]=a*b[2]+g*b[6]+f*b[10]+c*b[14];e[3]=a*b[3]+g*b[7]+f*b[11]+c*b[15];return e}function PointDistance(d,c){return Math.sqrt((d[0]-c[0])*(d[0]-c[0])+(d[1]-c[1])*(d[1]-c[1])+(d[2]-c[2])*(d[2]-c[2]))}var superblaze_calcNormal=function(d,b,a){var e=[d[0]-b[0],d[1]-b[1],d[2]-b[2]];var c=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];return[e[1]*c[2]-e[2]*c[1],e[2]*c[0]-e[0]*c[2],e[0]*c[1]-e[1]*c[0]]};var superblaze_normalize=function(a){var b=Math.sqrt((a[0]*a[0])+(a[1]*a[1])+(a[2]*a[2]));if(b==0){return[0,0,0]}return[a[0]/b,a[1]/b,a[2]/b]};var superblaze_length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])};var superblaze_dp=function(b,a){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]};var superblaze_angle=function(b,a){return Math.acos(superblaze_dp(b,a)/(superblaze_length(b)*superblaze_length(a)))};var superblaze_crossProduct=function(b,a){return[b[1]*a[2]-a[1]*b[2],b[2]*a[0]-a[2]*b[0],b[0]*a[1]-a[0]*b[1]]};var superblaze_vertex_mul_const=function(b,a){return[b[0]*a,b[1]*a,b[2]*a]};var superblaze_vertex_add=function(b,a){return[b[0]+a[0],b[1]+a[1],b[2]+a[2]]};var superblaze_vertex_sub=function(b,a){return[b[0]-a[0],b[1]-a[1],b[2]-a[2]]};var superblaze_vertex_scladd=function(c,b,a){return[c[0]+b[0]*a,c[1]+b[1]*a,c[2]+b[2]*a]};var superblaze_vtx_eq=function(d,c){return(d[0]==c[0]&&d[1]==c[1]&&d[2]==c[2])};var superblaze_uv_eq=function(d,c){return(d[0]==c[0]&&d[1]==c[1])};var superblaze_perspective=function(d,c,f,b){var a=Math.tan(d*M_PI/360);var e=a*c;return[1/e,0,0,0,0,1/a,0,0,0,0,-(b+f)/(b-f),-1,0,0,-(2*b*f)/(b-f),0]};var superblaze_lookat=function(c,a,b,e){var f=superblaze_normalize([a[0]-c[0],a[1]-c[1],a[2]-c[2]]);var d=superblaze_normalize(b);var i=superblaze_crossProduct(f,d);i=superblaze_normalize(i);var h=superblaze_crossProduct(i,f);h=superblaze_normalize(h);c=superblaze_vertex_scladd(c,i,e[0]);c=superblaze_vertex_scladd(c,h,e[1]);var g=[i[0],h[0],-f[0],0,i[1],h[1],-f[1],0,i[2],h[2],-f[2],0,0,0,0,1];trans=new superblaze_transform();trans.translate(-c[0],-c[1],-c[2]);trans.pushMatrix(g);g=trans.getResult();return g};var superblaze_compileShader=function(d,c,a){var b;if(a=="x-shader/x-fragment"){b=d.createShader(d.FRAGMENT_SHADER)}else{if(a=="x-shader/x-vertex"){b=d.createShader(d.VERTEX_SHADER)}else{return null}}d.shaderSource(b,c);d.compileShader(b);if(!d.getShaderParameter(b,d.COMPILE_STATUS)){console.log("***Compile Status "+d.getShaderInfoLog(b));return null}return b};var superblaze_getShader=function(e,f){var b=document.getElementById(f);if(!b){return null}var d="";var a=b.firstChild;while(a){if(a.nodeType==3){d+=a.textContent}a=a.nextSibling}var c;if(b.type=="x-shader/x-fragment"){c=e.createShader(e.FRAGMENT_SHADER)}else{if(b.type=="x-shader/x-vertex"){c=e.createShader(e.VERTEX_SHADER)}else{return null}}e.shaderSource(c,d);e.compileShader(c);if(!e.getShaderParameter(c,e.COMPILE_STATUS)){console.log("***"+e.getShaderInfoLog(c));return null}return c};superblaze_transform=function(a){return this.clearStack()};superblaze_transform.prototype.setIdentity=function(){this.m_stack[this.c_stack]=this.getIdentity();if(this.valid==this.c_stack&&this.c_stack){this.valid--}return this};superblaze_transform.prototype.getIdentity=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};superblaze_transform.prototype.invalidate=function(){this.valid=0;this.result=null;return this};superblaze_transform.prototype.getResult=function(){if(!this.c_stack){return this.m_stack[0]}if(this.valid!=this.c_stack){if(this.valid>this.c_stack){while(this.valid>this.c_stack+1){this.valid--;this.m_cache.pop()}}else{for(var a=this.valid;a<=this.c_stack;a++){this.m_cache[a]=(a==0)?this.m_stack[0]:this.multiply4_4by4_4(this.m_cache[a-1],this.m_stack[a]);this.valid++}}this.result=this.m_cache[this.valid-1]}return this.result};superblaze_transform.prototype.pushMatrix=function(a){this.c_stack++;this.m_stack.push(a?a:this.getIdentity());return this};superblaze_transform.prototype.popMatrix=function(){if(this.c_stack==0){return this}this.c_stack--;return this};superblaze_transform.prototype.clearStack=function(){this.m_stack=[];this.m_cache=[];this.c_stack=0;this.valid=0;this.result=null;if(typeof(init_mat)!="undefined"){this.m_stack[0]=init_mat}else{this.setIdentity()}return this};superblaze_transform.prototype.multiply4_4by4_4=function(c,b){var a=[];a[0]=b[0]*c[0]+b[4]*c[1]+b[8]*c[2]+b[12]*c[3];a[1]=b[1]*c[0]+b[5]*c[1]+b[9]*c[2]+b[13]*c[3];a[2]=b[2]*c[0]+b[6]*c[1]+b[10]*c[2]+b[14]*c[3];a[3]=b[3]*c[0]+b[7]*c[1]+b[11]*c[2]+b[15]*c[3];a[4]=b[0]*c[4]+b[4]*c[5]+b[8]*c[6]+b[12]*c[7];a[5]=b[1]*c[4]+b[5]*c[5]+b[9]*c[6]+b[13]*c[7];a[6]=b[2]*c[4]+b[6]*c[5]+b[10]*c[6]+b[14]*c[7];a[7]=b[3]*c[4]+b[7]*c[5]+b[11]*c[6]+b[15]*c[7];a[8]=b[0]*c[8]+b[4]*c[9]+b[8]*c[10]+b[12]*c[11];a[9]=b[1]*c[8]+b[5]*c[9]+b[9]*c[10]+b[13]*c[11];a[10]=b[2]*c[8]+b[6]*c[9]+b[10]*c[10]+b[14]*c[11];a[11]=b[3]*c[8]+b[7]*c[9]+b[11]*c[10]+b[15]*c[11];a[12]=b[0]*c[12]+b[4]*c[13]+b[8]*c[14]+b[12]*c[15];a[13]=b[1]*c[12]+b[5]*c[13]+b[9]*c[14]+b[13]*c[15];a[14]=b[2]*c[12]+b[6]*c[13]+b[10]*c[14]+b[14]*c[15];a[15]=b[3]*c[12]+b[7]*c[13]+b[11]*c[14]+b[15]*c[15];return a};superblaze_transform.prototype.m_mat=superblaze_transform.prototype.multiply4_4by4_4;superblaze_transform.prototype.multiply1_4by4_4=function(c,b){var a=[];a[0]=b[0]*c[0]+b[4]*c[1]+b[8]*c[2]+b[12]*c[3];a[1]=b[1]*c[0]+b[5]*c[1]+b[9]*c[2]+b[13]*c[3];a[2]=b[2]*c[0]+b[6]*c[1]+b[10]*c[2]+b[14]*c[3];a[3]=b[3]*c[0]+b[7]*c[1]+b[11]*c[2]+b[15]*c[3];return a};superblaze_transform.prototype.m_vector=superblaze_transform.prototype.multiply1_4by4_4;superblaze_transform.prototype.m_point=superblaze_transform.prototype.multiply1_3by4_4=function(c,b){var a=[];a[0]=b[0]*c[0]+b[4]*c[1]+b[8]*c[2]+b[12];a[1]=b[1]*c[0]+b[5]*c[1]+b[9]*c[2]+b[13];a[2]=b[2]*c[0]+b[6]*c[1]+b[10]*c[2]+b[14];return a};superblaze_transform.prototype.translate=function(b,d,c){if(typeof(b)=="object"){return this.translate(b[0],b[1],b[2])}var a=this.getIdentity();a[12]=b;a[13]=d;a[14]=c;this.m_stack[this.c_stack]=this.multiply4_4by4_4(this.m_stack[this.c_stack],a);if(this.valid==this.c_stack&&this.c_stack){this.valid--}return this};superblaze_transform.prototype.scale=function(b,d,c){if(typeof(b)=="object"){return this.scale(b[0],b[1],b[2])}var a=this.getIdentity();a[0]=b;a[5]=d;a[10]=c;this.m_stack[this.c_stack]=this.multiply4_4by4_4(this.m_stack[this.c_stack],a);if(this.valid==this.c_stack&&this.c_stack){this.valid--}return this};superblaze_transform.prototype.rotate=function(d,i,h,g){if(typeof(d)=="object"){this.rotate(d[2],0,0,1);this.rotate(d[1],0,1,0);this.rotate(d[0],1,0,0);return this}var e,f;if(i||h||g){e=Math.sin(d*(M_PI/180));f=Math.cos(d*(M_PI/180))}if(i){var c=this.getIdentity();c[5]=f*i;c[9]=e*i;c[6]=-e*i;c[10]=f*i;this.m_stack[this.c_stack]=this.multiply4_4by4_4(this.m_stack[this.c_stack],c)}if(h){var b=this.getIdentity();b[0]=f*h;b[8]=-e*h;b[2]=e*h;b[10]=f*h;this.m_stack[this.c_stack]=this.multiply4_4by4_4(this.m_stack[this.c_stack],b)}if(g){var a=this.getIdentity();a[0]=f*g;a[4]=e*g;a[1]=-e*g;a[5]=f*g;this.m_stack[this.c_stack]=this.multiply4_4by4_4(this.m_stack[this.c_stack],a)}if(this.valid==this.c_stack&&this.c_stack){this.valid--}return this};superblaze_face=function(){this.points=[];this.point_normals=[];this.uvs=[];this.normal=null;this.material=0;this.segment=0};superblaze_face.prototype.setUV=function(b,a){if(typeof(this.uvs)=="undefined"){this.uvs=[]}if(typeof(a)!="undefined"){this.uvs[a]=b}else{if(b.length!=2){this.uvs=b}else{this.uvs.push(b)}}};superblaze_object=function(){this.points=[];this.point_normals=[];this.uvs=[];this.faces=[];this.currentFace=-1;this.currentMaterial=0;this.currentSegment=0;this.compiled=null;this.bb=null;this.visible=1};superblaze_object.prototype.addPoint=function(b){if(b.length!=3){for(var a=0;a<b.length;a++){this.points.push(b[a])}}else{this.points.push(b)}return this.points.length-1};superblaze_object.prototype.addNormal=function(b){if(b.length!=3){for(var a=0;a<b.length;a++){this.point_normals.push(b[a])}}else{this.point_normals.push(b)}return this.point_normals.length-1};superblaze_object.prototype.addUV=function(b){if(b.length!=2){for(var a=0;a<b.length;a++){this.uvs.push(b[a])}}else{this.uvs.push(b)}return this.uvs.length-1};superblaze_object.prototype.setFaceMaterial=function(a){this.currentMaterial=(typeof(a)=="object")?a.material_id:a};superblaze_object.prototype.addFace=function(d,a,b,e){if(typeof(d[0])!="number"){for(var c in d){this.addFace(d[c])}return}if(typeof(a)=="undefined"){this.currentFace=this.faces.length;this.faces.push(new superblaze_face())}else{if(typeof(this.faces[a])=="undefined"){this.faces[a]=new superblaze_face()}this.currentFace=a}if(typeof(d)=="object"){this.faces[this.currentFace].points=d}if(typeof(b)!="undefined"){this.faces[this.currentFace].material=(typeof(b)=="object")?b.material_id:b}else{this.faces[this.currentFace].material=this.currentMaterial}if(typeof(e)!="undefined"){this.faces[this.currentFace].segment=e}else{this.faces[this.currentFace].segment=this.currentSegment}return this.currentFace};superblaze_object.prototype.CalcSurfTangents=function(){if(typeof(this.uvs)=="undefined"||this.uvs.length==0){return}this.tanus=[];this.tanvs=[];for(var g=0;g<this.faces.length;g++){var h=[],f=[],d=[],m=[],k=[];for(var q=0;q<3;q++){var l=this.faces[g].points[q];h[q]=this.points[l][0];f[q]=this.points[l][1];d[q]=this.points[l][2];if(typeof(this.uvs[l])!="undefined"){m[q]=this.uvs[l][0];k[q]=this.uvs[l][1]}else{m[q]=0;k[q]=0}}var o=[],n=[];var c=[],a=[];o[0]=h[1]-h[0];o[1]=f[1]-f[0];o[2]=d[1]-d[0];c[0]=m[1]-m[0];c[1]=k[1]-k[0];n[0]=h[2]-h[0];n[1]=f[2]-f[0];n[2]=d[2]-d[0];a[0]=m[2]-m[0];a[1]=k[2]-k[0];var b=[],p=[];b[0]=a[1]*o[0]-c[1]*n[0];b[1]=a[1]*o[1]-c[1]*n[1];b[2]=a[1]*o[2]-c[1]*n[2];b=superblaze_normalize(b);p[0]=a[0]*o[0]-c[0]*n[0];p[1]=a[0]*o[1]-c[0]*n[1];p[2]=a[0]*o[2]-c[0]*n[2];p=superblaze_normalize(p);for(var q=0;q<3;q++){var l=this.faces[g].points[q];if(typeof(this.tanus[l])=="undefined"){this.tanus[l]=[b[0],b[1],b[2]];this.tanvs[l]=[p[0],p[1],p[2]]}else{for(var e=0;e<3;e++){this.tanus[l][e]+=b[e];this.tanvs[l][e]+=p[e]}}}}for(var g=0;g<this.tanus.length;g++){this.tanus[g]=superblaze_normalize(this.tanus[g]);this.tanvs[g]=superblaze_normalize(this.tanvs[g])}};superblaze_object.prototype.compile=function(u){this.compiled=new Object();this.bb=[];var e=[];for(var t=0;t<this.faces.length;t++){if(this.faces[t].points.length==3){var o=this.faces[t].material;var q=this.faces[t].segment;if(typeof(e[o])=="undefined"){e[o]=[]}if(typeof(e[o][q])=="undefined"){e[o][q]=[]}e[o][q].push(t)}}var m=[];this.compiled.vbo_normals=[];this.compiled.vbo_points=[];this.compiled.vbo_uvs=[];this.compiled.vbo_tanus=[];this.compiled.vbo_tanvs=[];var f=0;for(var t in e){for(var s in e[t]){for(var r=0;r<e[t][s].length;r++){var a=e[t][s][r];var l=false;for(var h=0;h<3;h++){var b=this.faces[a].points[h];var p=-1;if(typeof(m[b])!="undefined"){for(var g=0;g<m[b].length;g++){var c=m[b][g][0];var n=m[b][g][1];var d=m[b][g][2];p=d}}if(p!=-1){if(typeof(this.compiled.elements)=="undefined"){this.compiled.elements=[]}if(typeof(this.compiled.elements[t])=="undefined"){this.compiled.elements[t]=[]}if(typeof(this.compiled.elements[t][s])=="undefined"){this.compiled.elements[t][s]=[]}this.compiled.elements[t][s].push(p)}else{this.compiled.vbo_points.push(this.points[b][0]);this.compiled.vbo_points.push(this.points[b][1]);this.compiled.vbo_points.push(this.points[b][2]);if(this.bb.length==0){this.bb[0]=[this.points[b][0],this.points[b][1],this.points[b][2]];this.bb[1]=[this.points[b][0],this.points[b][1],this.points[b][2]]}else{if(this.points[b][0]<this.bb[0][0]){this.bb[0][0]=this.points[b][0]}if(this.points[b][1]<this.bb[0][1]){this.bb[0][1]=this.points[b][1]}if(this.points[b][2]<this.bb[0][2]){this.bb[0][2]=this.points[b][2]}if(this.points[b][0]>this.bb[1][0]){this.bb[1][0]=this.points[b][0]}if(this.points[b][1]>this.bb[1][1]){this.bb[1][1]=this.points[b][1]}if(this.points[b][2]>this.bb[1][2]){this.bb[1][2]=this.points[b][2]}}this.compiled.vbo_normals.push(this.point_normals[b][0]);this.compiled.vbo_normals.push(this.point_normals[b][1]);this.compiled.vbo_normals.push(this.point_normals[b][2]);if(typeof(this.uvs[b])!="undefined"){this.compiled.vbo_uvs.push(this.uvs[b][0]);this.compiled.vbo_uvs.push(this.uvs[b][1])}else{this.compiled.vbo_uvs.push(0);this.compiled.vbo_uvs.push(0)}if(typeof(this.tanus)!="undefined"){this.compiled.vbo_tanus.push(this.tanus[b][0]);this.compiled.vbo_tanus.push(this.tanus[b][1]);this.compiled.vbo_tanus.push(this.tanus[b][2]);this.compiled.vbo_tanvs.push(this.tanvs[b][0]);this.compiled.vbo_tanvs.push(this.tanvs[b][1]);this.compiled.vbo_tanvs.push(this.tanvs[b][2])}else{this.compiled.vbo_tanus.push(1);this.compiled.vbo_tanus.push(0);this.compiled.vbo_tanus.push(0);this.compiled.vbo_tanvs.push(0);this.compiled.vbo_tanvs.push(1);this.compiled.vbo_tanvs.push(0)}if(typeof(this.compiled.elements)=="undefined"){this.compiled.elements=[]}if(typeof(this.compiled.elements[t])=="undefined"){this.compiled.elements[t]=[]}if(typeof(this.compiled.elements[t][s])=="undefined"){this.compiled.elements[t][s]=[]}this.compiled.elements[t][s].push(f);if(typeof(m[b])=="undefined"){m[b]=[]}m[b].push([a,h,f]);f++}}}}}};superblaze_object.prototype.loadToCard=function(e){if(this.subobjs!=null){for(var d=0;d<this.subobjs.length;d++){this.subobjs[d].mesh.loadToCard(e)}}if(this.compiled==null){return}this.compiled.gl_points=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.compiled.gl_points);e.gl.bufferData(e.gl.ARRAY_BUFFER,new Float32Array(this.compiled.vbo_points),e.gl.STATIC_DRAW);this.compiled.gl_normals=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.compiled.gl_normals);e.gl.bufferData(e.gl.ARRAY_BUFFER,new Float32Array(this.compiled.vbo_normals),e.gl.STATIC_DRAW);this.compiled.gl_uvs=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.compiled.gl_uvs);e.gl.bufferData(e.gl.ARRAY_BUFFER,new Float32Array(this.compiled.vbo_uvs),e.gl.STATIC_DRAW);this.compiled.gl_tanus=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.compiled.gl_tanus);e.gl.bufferData(e.gl.ARRAY_BUFFER,new Float32Array(this.compiled.vbo_tanus),e.gl.STATIC_DRAW);this.compiled.gl_tanvs=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this.compiled.gl_tanvs);e.gl.bufferData(e.gl.ARRAY_BUFFER,new Float32Array(this.compiled.vbo_tanvs),e.gl.STATIC_DRAW);var f=[];this.segment_state=[];for(var c in this.compiled.elements){for(var b in this.compiled.elements[c]){this.segment_state[b]=true;for(var a in this.compiled.elements[c][b]){f.push(this.compiled.elements[c][b][a])}}}this.compiled.gl_elements=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,this.compiled.gl_elements);e.gl.bufferData(e.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(f),e.gl.STATIC_DRAW)};superblaze_object.prototype.unload=function(b){if(this.subobjs!=null){for(var a=0;a<this.subobjs.length;a++){this.subobjs[a].mesh.unload(b)}}if(this.compiled==null){return}var c=b.gl;c.deleteBuffer(this.compiled.gl_elements);this.compiled.gl_elements=null;c.deleteBuffer(this.compiled.gl_tanus);this.compiled.gl_tanus=null;c.deleteBuffer(this.compiled.gl_tanvs);this.compiled.gl_tanvs=null;c.deleteBuffer(this.compiled.gl_uvs);this.compiled.gl_uvs=null;c.deleteBuffer(this.compiled.gl_normals);this.compiled.gl_normals=null;c.deleteBuffer(this.compiled.gl_points);this.compiled.gl_points=null};superblaze_material=function(a,b){this.scene=b;this.material_id=b._Materials.length;this.name=a;this.diffusecolor=[0,0,0];this.diffuseuserscale=1;this.glossycolor=[0,0,0];this.glossyuserscale=1;this.specularcolor=[0,0,0];this.specularuserscale=1;this.bumpuserscale=1;this.basecolor=[0,0,0];this.baseuserscale=0;this.fresnel=0;this.degree_0_specular=0.2;this.degree_90_specular=1;this.brdf_curve=5;this.opacity=1;this.invertreflectiony=1;this.textures=[];this.shader=[];this.scene._Materials.push(this);if(typeof(a)!="undefined"){this.scene._Material_ref[a]=this}};superblaze_material.prototype.unload=function(){this.shader=[]};superblaze_material.prototype.setTexture=function(a,b){if(typeof(b)=="undefined"){b=0}this.textures[b]=a};superblaze_intToFloatArray=function(a){var b=[];b[2]=(a&255)/255;b[1]=((a>>8)&255)/255;b[0]=((a>>16)&255)/255;return b};superblaze_material.prototype.getShaderHeader=function(a){return"#define hasAlphaTexture "+((typeof(this.textures[TEXTURE_MAP_ALPHATEX])!="undefined")?1:0)+"\n#define hasDiffuseTexture "+((typeof(this.textures[TEXTURE_MAP_DIFFUSETEX])!="undefined")?1:0)+"\n#define hasSpecularEnv "+((typeof(this.textures[TEXTURE_MAP_SPECULARENV])!="undefined")?1:0)+"\n#define hasSpecularTexture "+((typeof(this.textures[TEXTURE_MAP_SPECULARTEX])!="undefined")?1:0)+"\n#define hasGlossyEnv "+((typeof(this.textures[TEXTURE_MAP_GLOSSYENV])!="undefined")?1:0)+"\n#define hasGlossyTexture "+((typeof(this.textures[TEXTURE_MAP_GLOSSYTEX])!="undefined")?1:0)+"\n#define hasDiffuseEnv "+((typeof(this.textures[TEXTURE_MAP_DIFFUSEENV])!="undefined")?1:0)+"\n#define hasBumpTexture "+((typeof(this.textures[TEXTURE_MAP_BUMPTEX])!="undefined")?1:0)+"\n#define hasBaseTexture "+((typeof(this.textures[TEXTURE_MAP_BASETEX])!="undefined")?1:0)+"\n\n"};superblaze_material.prototype.bindObject=function(a,b){if(typeof(b)=="undefined"){b=0}this.scene.gl.bindBuffer(this.scene.gl.ARRAY_BUFFER,a.compiled.gl_tanus);this.scene.gl.vertexAttribPointer(this.shader[b].uniforms.aSurfTanU,3,this.scene.gl.FLOAT,false,0,0);this.scene.gl.bindBuffer(this.scene.gl.ARRAY_BUFFER,a.compiled.gl_tanvs);this.scene.gl.vertexAttribPointer(this.shader[b].uniforms.aSurfTanV,3,this.scene.gl.FLOAT,false,0,0);this.scene.gl.bindBuffer(this.scene.gl.ARRAY_BUFFER,a.compiled.gl_points);this.scene.gl.vertexAttribPointer(this.shader[b].uniforms.aVertexPosition,3,this.scene.gl.FLOAT,false,0,0);this.scene.gl.bindBuffer(this.scene.gl.ARRAY_BUFFER,a.compiled.gl_uvs);this.scene.gl.vertexAttribPointer(this.shader[b].uniforms.aTextureCoord,2,this.scene.gl.FLOAT,false,0,0);this.scene.gl.bindBuffer(this.scene.gl.ARRAY_BUFFER,a.compiled.gl_normals);this.scene.gl.vertexAttribPointer(this.shader[b].uniforms.aNormal,3,this.scene.gl.FLOAT,false,0,0);this.scene.gl.bindBuffer(this.scene.gl.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)};superblaze_material.prototype.use=function(a){if(typeof(a)=="undefined"){a=0}if(typeof(this.shader[a])=="undefined"){var b=this.getShaderHeader(a);if(this.type=="Glass"){this.shader[a]=new superblaze_shader(b+this.scene.CoreShader_vs,b+this.scene.GlassShader_fs,this.scene.gl);if(typeof(this.textures[TEXTURE_MAP_BUMPTEX])!="undefined"){this.shader[a].addInt("bumptexture",TEXTURE_MAP_BUMPTEX);this.shader[a].addFloat("bumpuserscale");this.shader[a].addVertexArray("aSurfTanU");this.shader[a].addVertexArray("aSurfTanV")}if(typeof(this.textures[TEXTURE_MAP_SPECULARTEX])!="undefined"){this.shader[a].addInt("speculartexture",TEXTURE_MAP_SPECULARTEX);this.shader[a].addFloat("speculartextureuvscale")}if(typeof(this.textures[TEXTURE_MAP_SPECULARENV])!="undefined"){this.shader[a].addInt("specularenv",TEXTURE_MAP_SPECULARENV);this.shader[a].addFloat2("specularcachescaleoffset")}this.shader[a].addVector("specularcolor");this.shader[a].addFloat("degree_0_specular");this.shader[a].addFloat("degree_90_specular");this.shader[a].addFloat("brdf_curve");if(typeof(this.textures[TEXTURE_MAP_BASETEX])!="undefined"){this.shader[a].addInt("basetexture",TEXTURE_MAP_BASETEX)}this.shader[a].addVector("basecolor")}else{if(this.type=="Ambient"){this.shader[a]=new superblaze_shader(b+this.scene.CoreShader_vs,b+this.scene.AmbientShader_fs,this.scene.gl);if(typeof(this.textures[TEXTURE_MAP_DIFFUSETEX])!="undefined"){this.shader[a].addInt("diffusetexture",TEXTURE_MAP_DIFFUSETEX);this.shader[a].addFloat("diffusetextureuvscale")}this.shader[a].addVector("diffusecolor")}else{this.shader[a]=new superblaze_shader(b+this.scene.CoreShader_vs,b+this.scene.CoreShader_fs,this.scene.gl);if(typeof(this.textures[TEXTURE_MAP_BUMPTEX])!="undefined"){this.shader[a].addInt("bumptexture",TEXTURE_MAP_BUMPTEX);this.shader[a].addFloat("bumpuserscale");this.shader[a].addVertexArray("aSurfTanU");this.shader[a].addVertexArray("aSurfTanV")}if(typeof(this.textures[TEXTURE_MAP_ALPHATEX])!="undefined"){this.shader[a].addInt("alphatexture",TEXTURE_MAP_ALPHATEX);this.shader[a].addFloat("alphatextureuvscale")}if(typeof(this.textures[TEXTURE_MAP_DIFFUSETEX])!="undefined"){this.shader[a].addInt("diffusetexture",TEXTURE_MAP_DIFFUSETEX);this.shader[a].addFloat("diffusetextureuvscale")}if(typeof(this.textures[TEXTURE_MAP_DIFFUSEENV])!="undefined"){this.shader[a].addInt("diffuseenv",TEXTURE_MAP_DIFFUSEENV);this.shader[a].addFloat2("diffusecachescaleoffset")}if(typeof(this.textures[TEXTURE_MAP_GLOSSYTEX])!="undefined"){this.shader[a].addInt("glossytexture",TEXTURE_MAP_GLOSSYTEX);this.shader[a].addFloat("glossytextureuvscale")}if(typeof(this.textures[TEXTURE_MAP_GLOSSYENV])!="undefined"){this.shader[a].addInt("glossyenv",TEXTURE_MAP_GLOSSYENV);this.shader[a].addFloat2("glossycachescaleoffset")}if(typeof(this.textures[TEXTURE_MAP_SPECULARTEX])!="undefined"){this.shader[a].addInt("speculartexture",TEXTURE_MAP_SPECULARTEX);this.shader[a].addFloat("speculartextureuvscale")}if(typeof(this.textures[TEXTURE_MAP_SPECULARENV])!="undefined"){this.shader[a].addInt("specularenv",TEXTURE_MAP_SPECULARENV);this.shader[a].addFloat2("specularcachescaleoffset")}this.shader[a].addVector("diffusecolor");this.shader[a].addVector("glossycolor");this.shader[a].addVector("specularcolor");this.shader[a].addInt("fresnel");this.shader[a].addFloat("degree_0_specular");this.shader[a].addFloat("degree_90_specular");this.shader[a].addFloat("brdf_curve");this.shader[a].addFloat("invertreflectiony")}}this.shader[a].addVector("uCamPos");this.shader[a].addVertexArray("aVertexPosition");this.shader[a].addVertexArray("aNormal");this.shader[a].addMatrix("uMVMatrix");this.shader[a].addMatrix("uPMatrix");this.shader[a].addMatrix("uOMatrix");this.shader[a].addUVArray("aTextureCoord");this.shader[a].addFloat2("jitter");this.shader[a].init()}this.shader[a].use();if(this.type=="Glass"){if(typeof(this.textures[TEXTURE_MAP_BUMPTEX])!="undefined"){this.textures[TEXTURE_MAP_BUMPTEX].use(this.scene.gl.TEXTURE7);this.shader[a].setFloat("bumpuserscale",this.bumpuserscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE7)}if(typeof(this.textures[TEXTURE_MAP_SPECULARTEX])!="undefined"){this.textures[TEXTURE_MAP_SPECULARTEX].use(this.scene.gl.TEXTURE5);this.shader[a].setFloat("speculartextureuvscale",this.textures[TEXTURE_MAP_SPECULARTEX]._wrapscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE5)}if(typeof(this.textures[TEXTURE_MAP_SPECULARENV])!="undefined"){this.textures[TEXTURE_MAP_SPECULARENV].use(this.scene.gl.TEXTURE6);this.shader[a].setFloat2("specularcachescaleoffset",this.textures[TEXTURE_MAP_SPECULARENV]._scale_offset)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE6)}this.shader[a].setVector("specularcolor",this.specularcolor);this.shader[a].setFloat("degree_0_specular",this.degree_0_specular);this.shader[a].setFloat("degree_90_specular",this.degree_90_specular);this.shader[a].setFloat("brdf_curve",this.brdf_curve);if(typeof(this.textures[TEXTURE_MAP_BASETEX])!="undefined"){this.textures[TEXTURE_MAP_BASETEX].use(this.scene.gl.TEXTURE8)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE8)}this.shader[a].setVector("basecolor",this.basecolor)}else{if(this.type=="Ambient"){if(typeof(this.textures[TEXTURE_MAP_DIFFUSETEX])!="undefined"){this.textures[TEXTURE_MAP_DIFFUSETEX].use(this.scene.gl.TEXTURE1);this.shader[a].setFloat("diffusetextureuvscale",this.textures[TEXTURE_MAP_DIFFUSETEX]._wrapscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE1)}this.shader[a].setVector("diffusecolor",this.diffusecolor)}else{if(typeof(this.textures[TEXTURE_MAP_BUMPTEX])!="undefined"){this.textures[TEXTURE_MAP_BUMPTEX].use(this.scene.gl.TEXTURE7);this.shader[a].setFloat("bumpuserscale",this.bumpuserscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE7)}if(typeof(this.textures[TEXTURE_MAP_ALPHATEX])!="undefined"){this.textures[TEXTURE_MAP_ALPHATEX].use(this.scene.gl.TEXTURE0);this.shader[a].setFloat("alphatextureuvscale",this.textures[TEXTURE_MAP_ALPHATEX]._wrapscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE0)}if(typeof(this.textures[TEXTURE_MAP_DIFFUSETEX])!="undefined"){this.textures[TEXTURE_MAP_DIFFUSETEX].use(this.scene.gl.TEXTURE1);this.shader[a].setFloat("diffusetextureuvscale",this.textures[TEXTURE_MAP_DIFFUSETEX]._wrapscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE1)}if(typeof(this.textures[TEXTURE_MAP_DIFFUSEENV])!="undefined"){this.textures[TEXTURE_MAP_DIFFUSEENV].use(this.scene.gl.TEXTURE2);this.shader[a].setFloat2("diffusecachescaleoffset",this.textures[TEXTURE_MAP_DIFFUSEENV]._scale_offset)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE2)}if(typeof(this.textures[TEXTURE_MAP_GLOSSYTEX])!="undefined"){this.textures[TEXTURE_MAP_GLOSSYTEX].use(this.scene.gl.TEXTURE3);this.shader[a].setFloat("glossytextureuvscale",this.textures[TEXTURE_MAP_GLOSSYTEX]._wrapscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE3)}if(typeof(this.textures[TEXTURE_MAP_GLOSSYENV])!="undefined"){this.textures[TEXTURE_MAP_GLOSSYENV].use(this.scene.gl.TEXTURE4);this.shader[a].setFloat2("glossycachescaleoffset",this.textures[TEXTURE_MAP_GLOSSYENV]._scale_offset)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE4)}if(typeof(this.textures[TEXTURE_MAP_SPECULARTEX])!="undefined"){this.textures[TEXTURE_MAP_SPECULARTEX].use(this.scene.gl.TEXTURE5);this.shader[a].setFloat("speculartextureuvscale",this.textures[TEXTURE_MAP_SPECULARTEX]._wrapscale)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE5)}if(typeof(this.textures[TEXTURE_MAP_SPECULARENV])!="undefined"){this.textures[TEXTURE_MAP_SPECULARENV].use(this.scene.gl.TEXTURE6);this.shader[a].setFloat2("specularcachescaleoffset",this.textures[TEXTURE_MAP_SPECULARENV]._scale_offset)}else{clearTextureUnit(this.scene.gl,this.scene.gl.TEXTURE6)}this.shader[a].setVector("diffusecolor",this.diffusecolor);this.shader[a].setVector("glossycolor",this.glossycolor);this.shader[a].setVector("specularcolor",this.specularcolor);this.shader[a].setInt("fresnel",this.fresnel);this.shader[a].setFloat("degree_0_specular",this.degree_0_specular);this.shader[a].setFloat("degree_90_specular",this.degree_90_specular);this.shader[a].setFloat("brdf_curve",this.brdf_curve);this.shader[a].setFloat("invertreflectiony",this.invertreflectiony)}}};superblaze_shader=function(c,d,b){this.gl=b;var e;var a;this.uniforms=[];this.uniform_type=[];if(c.indexOf("\n")!=-1){e=superblaze_compileShader(this.gl,c,"x-shader/x-vertex")}else{e=superblaze_getShader(this.gl,c)}if(d.indexOf("\n")!=-1){a=superblaze_compileShader(this.gl,d,"x-shader/x-fragment")}else{a=superblaze_getShader(this.gl,d)}this.shader=this.gl.createProgram();this.gl.attachShader(this.shader,e);this.gl.attachShader(this.shader,a);this.gl.linkProgram(this.shader);if(!this.gl.getProgramParameter(this.shader,this.gl.LINK_STATUS)){console.log("***Could not initialise shader vert("+c+"), frag("+d+")")}};superblaze_shader.prototype.addMatrix=function(a){this.use();this.uniforms[a]=this.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=UNIFORM_TYPE_MATRIX};superblaze_shader.prototype.addVector=function(a){this.use();this.uniforms[a]=this.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=UNIFORM_TYPE_VECTOR};superblaze_shader.prototype.addFloat=function(a){this.use();this.uniforms[a]=this.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=UNIFORM_TYPE_FLOAT};superblaze_shader.prototype.addFloat2=function(a){this.use();this.uniforms[a]=this.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=UNIFORM_TYPE_FLOAT2};superblaze_shader.prototype.addVertexArray=function(a){this.use();this.uniforms[a]=this.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=UNIFORM_TYPE_ARRAY_VERTEX};superblaze_shader.prototype.addUVArray=function(a){this.use();this.uniforms[a]=this.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=UNIFORM_TYPE_ARRAY_UV};superblaze_shader.prototype.addInt=function(a,b){this.use();this.uniforms[a]=this.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=UNIFORM_TYPE_INT;if(typeof(b)!="undefined"){this.setInt(a,b)}};superblaze_shader.prototype.use=function(){this.gl.useProgram(this.shader)};superblaze_shader.prototype.init=function(a){if(typeof(a)=="undefined"){a=true}for(var b in this.uniforms){switch(this.uniform_type[b]){case UNIFORM_TYPE_MATRIX:break;case UNIFORM_TYPE_VECTOR:break;case UNIFORM_TYPE_FLOAT:case UNIFORM_TYPE_FLOAT2:break;case UNIFORM_TYPE_ARRAY_VERTEX:case UNIFORM_TYPE_ARRAY_UV:case UNIFORM_TYPE_ARRAY_FLOAT:if(a){this.gl.enableVertexAttribArray(this.uniforms[b])}else{this.gl.disableVertexAttribArray(this.uniforms[b])}break;default:break}}};superblaze_shader.prototype.setMatrix=function(b,a){this.gl.uniformMatrix4fv(this.uniforms[b],false,new Float32Array(a))};superblaze_shader.prototype.setInt=function(a,b){this.gl.uniform1i(this.uniforms[a],b)};superblaze_shader.prototype.setFloat=function(a,b){this.gl.uniform1f(this.uniforms[a],b)};superblaze_shader.prototype.setFloat2=function(a,b){this.gl.uniform2f(this.uniforms[a],b[0],b[1])};superblaze_shader.prototype.setVector=function(a,b){this.gl.uniform3fv(this.uniforms[a],b)};superblaze_texture=function(c,h,g,b,f){try{this.tex_id=f._Textures.length;this.name=c;this.type=h;this._scene=f;this.loaded=false;this._wrap="clamp";this._wrapscale=1;this._img_path=g;if(b!=null){this._lstFiles=[];for(var a=0;a<b.length;a++){this._lstFiles.push(b[a].firstChild.nodeValue)}}else{this._lstFiles=null}this._decoded=false;this._images=[];this.filtering=this._scene.gl.LINEAR;this._scale_offset=[1,0];f._Textures[this.tex_id]=null;f._Texture_ref[c]=this;f._TextureObjs.push(this)}catch(d){console.log("***ERROR: Loading Texture '"+c+"' "+d)}};superblaze_texture.prototype.unload=function(){this._scene.gl.deleteTexture(this._scene._Textures[this.tex_id]);this._scene._Textures[this.tex_id]=null;this._images=[];this.loaded=false};superblaze_texture.prototype.use=function(a){this._scene.gl.activeTexture(a);if(!this.loaded){this._scene._Textures[this.tex_id]=scene.gl.createTexture();this.loaded=true;try{if(this.type=="FileCube"){this._scene.gl.pixelStorei(this._scene.gl.UNPACK_FLIP_Y_WEBGL,false);this._scene.gl.bindTexture(this._scene.gl.TEXTURE_CUBE_MAP,scene._Textures[this.tex_id]);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_CUBE_MAP,this._scene.gl.TEXTURE_MAG_FILTER,this.filtering);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_CUBE_MAP,this._scene.gl.TEXTURE_MIN_FILTER,this.filtering);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_CUBE_MAP,this._scene.gl.TEXTURE_WRAP_S,this._scene.gl.CLAMP_TO_EDGE);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_CUBE_MAP,this._scene.gl.TEXTURE_WRAP_T,this._scene.gl.CLAMP_TO_EDGE);this._scene.gl.texImage2D(this._scene.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,this._scene.gl.RGBA,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,this._images[1]);this._scene.gl.texImage2D(this._scene.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this._scene.gl.RGBA,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,this._images[0]);this._scene.gl.texImage2D(this._scene.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this._scene.gl.RGBA,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,this._images[3]);this._scene.gl.texImage2D(this._scene.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this._scene.gl.RGBA,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,this._images[2]);this._scene.gl.texImage2D(this._scene.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this._scene.gl.RGBA,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,this._images[5]);this._scene.gl.texImage2D(this._scene.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this._scene.gl.RGBA,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,this._images[4]);this._scene.gl.bindTexture(this._scene.gl.TEXTURE_CUBE_MAP,null)}else{this._scene.gl.pixelStorei(this._scene.gl.UNPACK_FLIP_Y_WEBGL,true);this._scene.gl.bindTexture(this._scene.gl.TEXTURE_2D,scene._Textures[this.tex_id]);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_MAG_FILTER,this.filtering);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_MIN_FILTER,this.filtering);if(this._wrap=="repeat"){this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_WRAP_S,this._scene.gl.REPEAT);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_WRAP_T,this._scene.gl.REPEAT)}else{this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_WRAP_S,this._scene.gl.CLAMP_TO_EDGE);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_WRAP_T,this._scene.gl.CLAMP_TO_EDGE)}this._scene.gl.texImage2D(this._scene.gl.TEXTURE_2D,0,this._scene.gl.RGBA,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,this._images[0]);this._scene.gl.bindTexture(this._scene.gl.TEXTURE_2D,null)}}catch(b){console.log("***ERROR: Binding Texture '"+this.name+"' "+b)}}if(this.type=="FileCube"){this._scene.gl.bindTexture(this._scene.gl.TEXTURE_CUBE_MAP,this._scene._Textures[this.tex_id])}else{this._scene.gl.bindTexture(this._scene.gl.TEXTURE_2D,this._scene._Textures[this.tex_id])}};function clearTextureUnit(a,b){a.activeTexture(b);a.bindTexture(a.TEXTURE_CUBE_MAP,null);a.bindTexture(a.TEXTURE_2D,null)}superblaze_texture.prototype.startFileDownloads=function(){if((this.type=="File")||(this.type=="FileEnv")||(this.type=="FileCube")){if(typeof(this._scene._Images[this.tex_id])=="undefined"){var a;var c=this._scene;if(this._lstFiles!=null){for(var b=0;b<this._lstFiles.length;b++){a=new Image();this._images.push(a);a.onload=function(){c._outstandingjobs--};a.onerror=function(){console.log("Error: "+this.src)};a.src=this._img_path+this._lstFiles[b];this._scene._outstandingjobs++;this._scene._totaljobs++}}else{a=new Image();this._images.push(a);a.onload=function(){c._outstandingjobs--};a.onerror=function(){console.log("Error: "+this.src)};a.src=this._img_path;this._scene._outstandingjobs++;this._scene._totaljobs++}this._scene._Images[this.tex_id]=this._images[0]}}};superblaze_texture.prototype.refresh=function(){if(this._decoded){return true}this._decoded=true;if(this.type=="Noise"){var g=512,a=512;var o;var C=Array(g*a);var b=Math.random;var d=this.noisecontrast;var k=this.noisebrightness+0.5;for(var l=0;l<a;l++){var w=l*g;for(var m=0;m<g;m++){o=((b()-0.5)*d)+k;o*=255;if(o>255){o=255}else{if(o<0){o=0}}C[w+m]=o}}if(this.noiserounds>0){var h=Array(g*a);var q=Array();for(var z=0;z<this.noiserounds;z++){for(var l=0;l<a;l++){var B=((l>0)?l-1:a-1)*g;var D=((l<a-1)?l+1:0)*g;var e=l*g;var E;for(var m=0;m<g;m++){var n=(m>0)?m-1:g-1;var p=(m<g-1)?m+1:0;q[0]=C[B+n];q[1]=C[B+m];q[2]=C[B+p];q[3]=C[e+n];q[4]=C[e+m];q[5]=C[e+p];q[6]=C[D+n];q[7]=C[D+m];q[8]=C[D+p];if(q[1]>q[2]){E=q[1];q[1]=q[2];q[2]=E}if(q[4]>q[5]){E=q[4];q[4]=q[5];q[5]=E}if(q[7]>q[8]){E=q[7];q[7]=q[8];q[8]=E}if(q[0]>q[1]){E=q[0];q[0]=q[1];q[1]=E}if(q[3]>q[4]){E=q[3];q[3]=q[4];q[4]=E}if(q[6]>q[7]){E=q[6];q[6]=q[7];q[7]=E}if(q[1]>q[2]){E=q[1];q[1]=q[2];q[2]=E}if(q[4]>q[5]){E=q[4];q[4]=q[5];q[5]=E}if(q[7]>q[8]){E=q[7];q[7]=q[8];q[8]=E}if(q[0]>q[3]){E=q[0];q[0]=q[3];q[3]=E}if(q[5]>q[8]){E=q[5];q[5]=q[8];q[8]=E}if(q[4]>q[7]){E=q[4];q[4]=q[7];q[7]=E}if(q[3]>q[6]){E=q[3];q[3]=q[6];q[6]=E}if(q[1]>q[4]){E=q[1];q[1]=q[4];q[4]=E}if(q[2]>q[5]){E=q[2];q[2]=q[5];q[5]=E}if(q[4]>q[7]){E=q[4];q[4]=q[7];q[7]=E}if(q[4]>q[2]){E=q[4];q[4]=q[2];q[2]=E}if(q[6]>q[4]){E=q[6];q[6]=q[4];q[4]=E}if(q[4]>q[2]){E=q[4];q[4]=q[2];q[2]=E}h[e+m]=q[4]}}for(var c=0;c<g*a;c++){C[c]=h[c]}}}var i=document.createElement("canvas");i.width=this.width;i.height=this.height;var f=i.getContext("2d");var u=f.getImageData(0,0,this.width,this.height);var A=u.data;this._pixels=A;for(var l=0;l<this.height;l++){var w=l*this.width;for(var m=0;m<this.width;m++){var v=((l&511)<<9)+(m&511);var t=C[v];var j=4*(w+m);A[j]=t;A[j+1]=t;A[j+2]=t;A[j+3]=255}}u.data=A;this._images.push(u)}else{if(this.type=="Operation"){this.performTexOp()}}return false};superblaze_texture.prototype.performTexOp=function(){this._tex1=scene._Texture_ref[this.tex1name];this._tex1.refresh();if(typeof(this.tex2name)!="undefined"){this._tex2=scene._Texture_ref[this.tex2name];this._tex2.refresh()}if(typeof(this.tex3name)!="undefined"){this._tex3=scene._Texture_ref[this.tex3name];this._tex3.refresh()}var f=this._scene.gl.createFramebuffer();this._scene.gl.bindFramebuffer(this._scene.gl.FRAMEBUFFER,f);var g=this._scene.gl.createTexture();this._scene.gl.bindTexture(this._scene.gl.TEXTURE_2D,g);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_MAG_FILTER,this._scene.gl.LINEAR);this._scene.gl.texParameteri(this._scene.gl.TEXTURE_2D,this._scene.gl.TEXTURE_MIN_FILTER,this._scene.gl.LINEAR);this._scene.gl.texImage2D(this._scene.gl.TEXTURE_2D,0,this._scene.gl.RGBA,this.width,this.height,0,this._scene.gl.RGBA,this._scene.gl.UNSIGNED_BYTE,null);this._scene.gl.framebufferTexture2D(this._scene.gl.FRAMEBUFFER,this._scene.gl.COLOR_ATTACHMENT0,this._scene.gl.TEXTURE_2D,g,0);this._scene.gl.bindFramebuffer(this._scene.gl.FRAMEBUFFER,f);this._scene.gl.viewport(0,0,this.width,this.height);var a=this._scene.gl.createProgram();var l="precision mediump float; \nattribute vec2 a_position; \nattribute vec2 a_tex0; \nvarying vec2 uv0; \nvoid main() \n{ \n uv0 = a_tex0; \n gl_Position = vec4(a_position, 0.0, 1.0); \n}";var j=superblaze_compileShader(this._scene.gl,l,"x-shader/x-vertex");this._scene.gl.attachShader(a,j);var b="";b+="precision mediump float; \n";b+="varying vec2 uv0; \n";b+="uniform sampler2D tex1; \n";if(typeof(this.tex2name)!="undefined"){b+="uniform sampler2D tex2; \n"}if(typeof(this.tex3name)!="undefined"){b+="uniform sampler2D tex3; \n"}b+="void main() \n";b+="{ \n";if(this.operation=="Invert"){b+="gl_FragColor = vec4(1.0-texture2D(tex1, uv0).xyz, 1.0); \n"}else{if(this.operation=="Add"){b+="gl_FragColor = vec4(texture2D(tex1, uv0).xyz+texture2D(tex2, uv0).xyz, 1.0); \n"}else{if(this.operation=="Subtract"){b+="gl_FragColor = vec4(texture2D(tex1, uv0).xyz-texture2D(tex2, uv0).xyz, 1.0); \n"}else{if(this.operation=="Multiply"){b+="gl_FragColor = vec4(texture2D(tex1, uv0).xyz*texture2D(tex2, uv0).xyz, 1.0); \n"}else{if(this.operation=="Blend"){b+="float val1 = texture2D(tex3, uv0).x;\n";b+="float val2 = 1.0-val1;\n";b+="gl_FragColor = vec4((val1*texture2D(tex1, uv0).xyz)+(val2*texture2D(tex2, uv0).xyz), 1.0); \n"}}}}}b+="} \n";var d=superblaze_compileShader(this._scene.gl,b,"x-shader/x-fragment");this._scene.gl.attachShader(a,d);this._scene.gl.linkProgram(a);if(!this._scene.gl.getProgramParameter(a,this._scene.gl.LINK_STATUS)){console.log("***Could not initialise tex op shader");return}this._scene.gl.clear(this._scene.gl.COLOR_BUFFER_BIT);this._scene.gl.useProgram(a);this._tex1.use(this._scene.gl.TEXTURE1);this._scene.gl.uniform1i(this._scene.gl.getUniformLocation(a,"tex1"),1);if(typeof(this.tex2name)!="undefined"){this._tex2.use(this._scene.gl.TEXTURE2);this._scene.gl.uniform1i(this._scene.gl.getUniformLocation(a,"tex2"),2)}if(typeof(this.tex3name)!="undefined"){this._tex3.use(this._scene.gl.TEXTURE3);this._scene.gl.uniform1i(this._scene.gl.getUniformLocation(a,"tex3"),3)}var m=new Float32Array([-1,-1,1,-1,-1,1,1,1]);var e=this._scene.gl.getAttribLocation(a,"a_position");var i=this._scene.gl.createBuffer();this._scene.gl.bindBuffer(this._scene.gl.ARRAY_BUFFER,i);this._scene.gl.bufferData(this._scene.gl.ARRAY_BUFFER,m,this._scene.gl.STATIC_DRAW);this._scene.gl.vertexAttribPointer(e,2,this._scene.gl.FLOAT,false,0,0);this._scene.gl.enableVertexAttribArray(e);var c=new Float32Array([0,0,1,0,0,1,1,1]);var k=this._scene.gl.getAttribLocation(a,"a_tex0");var h=this._scene.gl.createBuffer();this._scene.gl.bindBuffer(this._scene.gl.ARRAY_BUFFER,h);this._scene.gl.bufferData(this._scene.gl.ARRAY_BUFFER,c,this._scene.gl.STATIC_DRAW);this._scene.gl.vertexAttribPointer(k,2,this._scene.gl.FLOAT,false,0,0);this._scene.gl.enableVertexAttribArray(k);this._scene.gl.drawArrays(this._scene.gl.TRIANGLE_STRIP,0,4);this._scene._Textures[this.tex_id]=g;this.loaded=true};superblaze_anim=function(){this.transforms=[];this.curves=[];this.framesleft=0;this.currentinput=0;this.positionjump=false;this.delta=0;this.onComplete=function(){}};superblaze_anim.prototype.isPlaying=function(){return(this.framesleft>0)};superblaze_anim.prototype.position=function(){return this.currentinput};superblaze_anim.prototype.play=function(a,c,b){if(c==0){this.currentinput=a;this.positionjump=true;return}this.positionjump=false;this.delta=(a-this.currentinput)/c;this.framesleft=c;if(b!==undefined){this.onComplete=b}};superblaze_anim.prototype.step=function(){if(this.positionjump){this.positionjump=false;return true}if(this.framesleft==0){this.onComplete();this.onComplete=function(){};return false}this.currentinput+=this.delta;this.framesleft--;return true};superblaze_anim.prototype.stop=function(){this.framesleft=0;this.delta=0};superblaze_sceneObject=function(a){this.position=[0,0,0];this.rotation=[0,0,0];this.scale=[0,0,0];this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.trans=new superblaze_transform();this.tMatrix=this.trans.getResult();this.dirty=true;this.obj=(typeof(a)!="undefined")?a:null;this.aabb=[]};superblaze_sceneObject.prototype.doTransform=function(){if(!superblaze_vtx_eq(this.lposition,this.position)||!superblaze_vtx_eq(this.lrotation,this.rotation)||!superblaze_vtx_eq(this.lscale,this.scale)){this.trans.clearStack();if(!(this.rotation[0]==0&&this.rotation[1]==0&&this.rotation[2]==0)){this.trans.rotate(this.rotation);this.trans.pushMatrix()}this.trans.translate(this.position);this.tMatrix=this.trans.getResult();this.lposition=this.position;this.lrotation=this.rotation;this.lscale=this.scale;this.dirty=true}};var g_slowinoutfac=1;function slowinout(a,b){var c=Math.abs(a-0.5)*2;c=Math.pow(c,b);c=(c*0.5)+0.5;if(a<0.5){c=1-c}return c}function evaluateSceneNode(e,f){var i=slowinout(f.currentinput,g_slowinoutfac);var a,b;e.matrix=superblaze_identity.slice(0);for(var g=0;g<f.transforms.length;g++){var d=f.transforms[g];var h=false;b=superblaze_identity.slice(0);for(var j=0;j<f.curves.length;j++){var c=f.curves[j];if(g!=c._transformidx){continue}h=true;a=superblaze_identity;var k=evaluateAnimationCurve(c,i);if(d._type=="translation"){if(c._qualifier==".X"){a=MatrixTranslation(k,0,0)}else{if(c._qualifier==".Y"){a=MatrixTranslation(0,k,0)}else{if(c._qualifier==".Z"){a=MatrixTranslation(0,0,k)}}}}else{if(d._type=="rotation"){a=MatrixRotationAxis(k/180*M_PI,d.x,d.y,d.z)}else{if(d._type=="scale"){if(c._qualifier==".X"){a=MatrixScaling(k,0,0)}else{if(c._qualifier==".Y"){a=MatrixScaling(0,k,0)}else{if(c._qualifier==".Z"){a=MatrixScaling(0,0,k)}}}}}}b=MatrixMultiply(a,b)}if(!h){if(d._type=="translation"){b=MatrixTranslation(d.x,d.y,d.z)}else{if(d._type=="rotation"){b=MatrixRotationAxis(d._angle/180*M_PI,d.x,d.y,d.z)}else{if(d._type=="scale"){b=MatrixScaling(d.x,d.y,d.z)}}}}e.matrix=MatrixMultiply(b,e.matrix)}}function FindT(i,e,l,g,j,h){var f=0.001;var c=1;var k=0;var m=0.5;if(h<=0.1){m=0.1}else{if(h>=0.9){m=0.9}else{m=h}}var b=true;while((c-k)>f){if(b){b=false}else{m=(c-k)/2+k}var a=1-m;var d=i*a*a*a+3*e*m*a*a+3*l*m*m*a+g*m*m*m;if(Math.abs(d-j)<=f){break}if(d>j){c=m}else{k=m}}return m}function evaluateAnimationCurve(i,e){if(i._keys.length==0){return 0}if(i._keys.length==1){return i._keys[0]._output}var H=i._keys[0]._input;var M=i._keys[i._keys.length-1]._input;var z=M-H;var o=i._keys[0]._output;var l=i._keys[i._keys.length-1]._output;var j=l-o;var p=0;if(e<H){var a=H-e;switch(i._preInfinity){case FANIM_INFINITY_CONSTANT:return o;case FANIM_INFINITY_LINEAR:return o+a*(i._keys[1]._output-o)/(i._keys[1]._input-H);case FANIM_INFINITY_CYCLE:var G=ceilf(a/z);e+=G*z;break;case FANIM_INFINITY_CYCLE_RELATIVE:var G=ceilf(a/z);e+=G*z;p-=G*j;break;case FANIM_INFINITY_OSCILLATE:var G=ceilf(a/(2*z));e+=G*2*z;e=M-Math.abs(e-M);break;default:return o}}else{if(e>=M){var a=e-M;switch(i._postInfinity){case FANIM_INFINITY_CONSTANT:return l;case FANIM_INFINITY_LINEAR:return l+a*(i._keys[i._keys.length-2]._output-l)/(i._keys[i._keys.length-2]._input-M);case FANIM_INFINITY_CYCLE:var G=ceilf(a/z);e-=G*z;break;case FANIM_INFINITY_CYCLE_RELATIVE:var G=ceilf(a/z);e-=G*z;p+=G*j;break;case FANIM_INFINITY_OSCILLATE:var G=ceilf(a/(2*z));e-=G*2*z;e=H+Math.abs(e-H);break;default:return l}}}var k;for(k=0;k<i._keys.length;k++){if(i._keys[k]._input>=e){break}}if(k==0){return p+o}var I=i._keys[k-1];var h=i._keys[k];var g=h._input-I._input;var B=h._output-I._output;var y;switch(I._interpolation){case FANIM_INTERPOLATION_LINEAR:y=I._output+(e-I._input)/g*B;break;case FANIM_INTERPOLATION_BEZIER:if(h._interpolation==FANIM_INTERPOLATION_LINEAR){y=I._output+(e-I._input)/g*B;break}if(h._interpolation==FANIM_INTERPOLATION_STEP){y=I._output;break}var q=I;var K=[0,0];if(h._interpolation==FANIM_INTERPOLATION_BEZIER){K[0]=h._inTangent[0];K[1]=h._inTangent[1]}else{if(h._interpolation==FANIM_INTERPOLATION_TCB){var v=h;var u=[0,0];var m=(k+1)<i._keys.length?i._keys[k+1]:null;computeTCBTangent(I,h,m,v._tension,v._continuity,v._bias,K,u);K[0]=h._input+K[0];K[1]=h._output+K[1]}}var E=(e-I._input)/g;if(i._is2DCurveEvaluation){E=FindT(q._input,q._outTangent[0],K[0],h._input,e,E)}var L=q._outTangent[1];var J=K[1];var d=1-E;var F=3;var x=3;if(!i._is2DCurveEvaluation){F=g/(q._outTangent[0]-I._input);x=g/(h._input-K[0]);if(F<0.01){F=0.01}else{if(F>100){F=100}}if(x<0.01){x=0.01}else{if(x>100){x=100}}}y=I._output*d*d*d+F*L*d*d*E+x*J*d*E*E+h._output*E*E*E;break;case FANIM_INTERPOLATION_TCB:if(h._interpolation==FANIM_INTERPOLATION_LINEAR){y=I._output+(e-I._input)/g*B;break}if(h._interpolation==FANIM_INTERPOLATION_STEP){y=I._output;break}var w=I;var f=Array(),u=Array(),n=Array();f[0]=f[1]=u[0]=u[1]=n[0]=n[1]=0;var A=(k-1)>0?i._keys[k-2]:null;computeTCBTangent(A,I,h,w._tension,w._continuity,w._bias,u,f);var C=0,r=0;var D=0,s=0;if(h._interpolation==FANIM_INTERPOLATION_TCB){var v=h;var m=(k+1)<i._keys.length?i._keys[k+1]:null;computeTCBTangent(I,h,m,v._tension,v._continuity,v._bias,n,u);r=h._output+n[1];s=h._output+n[0]}else{if(h._interpolation==FANIM_INTERPOLATION_BEZIER){var v=h;n[0]=v._inTangent[0];n[1]=v._inTangent[1];r=n[1];s=n[0]}}var E=(e-H)/g;C=I._output-f[1];D=I._input-f[0];if(i._is2DCurveEvaluation){E=FindT(w._input,D,s,h._input,e,E)}var d=1-E;y=I._output*d*d*d+3*C*E*d*d+3*r*E*E*d+h._output*E*E*E;break;case FANIM_INTERPOLATION_STEP:default:y=I._output;break}return p+y}function computeTCBTangent(j,i,k,b,n,d,m,e){if(i==null){return}var a=Array();var l=Array();if(!j){if(k){a[0]=k._input-i._input}else{a[0]=0.5}a[1]=0}else{a[0]=j._input-i._input;a[1]=j._output-i._output}if(!k){if(j){l[0]=i._input-j._input}else{l[0]=0.5}l[1]=0}else{l[0]=k._input-i._input;l[1]=k._output-i._output}var h=((1-b)*(1-n)*(1+d))/2;var g=((1-b)*(1+n)*(1-d))/2;var f=((1-b)*(1+n)*(1+d))/2;var c=((1-b)*(1-n)*(1-d))/2;m[0]=h*a[0]+g*l[0];m[1]=h*a[1]+g*l[1];e[0]=f*a[0]+c*l[0];e[1]=f*a[1]+c*l[1]}superblaze_scene=function(b,c,e,f){this._projectparsed=false;this._started=false;this._bAllowDirectRender=true;this.urlRoot=c;this.gl=b;this.CoreShader_vs=shaderSuperBlaze_Corevs;this.CoreShader_fs=shaderSuperBlaze_Corefs;this.GlassShader_fs=shaderSuperBlaze_Glassfs;this.AmbientShader_fs=shaderSuperBlaze_Ambientfs;this.gl.enable(this.gl.DEPTH_TEST);this.gl.depthFunc(this.gl.LEQUAL);this.gl.enable(this.gl.CULL_FACE);this.gl.cullFace(this.gl.BACK);this.gl.frontFace(this.gl.CCW);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.viewport(0,0,e,f);this._backgroundColor=[0,0,0];this.setBackgroundTransparent(false);this.prepareTexId=0;this._outstandingjobs=1;this._totaljobs=1;this._jitter=[];this._prepared=false;this._animRequiresClear=false;this._animEval=false;this.resetCounts();this.viewwidth=e;this.viewheight=f;this.fovy=30;this._bbmax=[-1000000,-1000000,-1000000];this._bbmin=[1000000,1000000,1000000];this._initialViewMatrix=superblaze_identity.slice(0);this._initialNavMatrix=superblaze_identity.slice(0);this.uiSprites=[];this._Textures=[];this._Texture_ref=[];this._Images=[];this._TextureObjs=[];this._Materials=[];this._Material_ref=[];var d=new XMLHttpRequest();d._scene=this;var a=this.urlRoot+"hierarchy.xml";d.open("GET",a,true);d.setRequestHeader("Content-Type","text/xml");d.onload=function(v){var p=d.responseXML;if(d.status!=200){console.log("***Error "+d.status+" readystate "+d.readyState);return}var y=p.getElementsByTagName("texture");for(var t=0;t<y.length;t++){var x;var r=y[t];var q=r.getElementsByTagName("name")[0].firstChild.nodeValue;var w=r.getElementsByTagName("type")[0].firstChild.nodeValue;if((w=="File")||(w=="FileEnv")){var g=r.getElementsByTagName("filename")[0].firstChild.nodeValue;x=new superblaze_texture(q,w,d._scene.urlRoot+g,null,d._scene);if(r.getElementsByTagName("scale").length){x._scale_offset[0]=parseFloat(r.getElementsByTagName("scale")[0].firstChild.nodeValue)}if(r.getElementsByTagName("offset").length){x._scale_offset[1]=parseFloat(r.getElementsByTagName("offset")[0].firstChild.nodeValue)}if(r.getElementsByTagName("wrap").length){x._wrap=r.getElementsByTagName("wrap")[0].firstChild.nodeValue}if(r.getElementsByTagName("wrapscale").length){x._wrapscale=parseFloat(r.getElementsByTagName("wrapscale")[0].firstChild.nodeValue)}}else{if(w=="FileCube"){x=new superblaze_texture(q,w,d._scene.urlRoot,r.getElementsByTagName("filename"),d._scene);if(r.getElementsByTagName("scale").length){x._scale_offset[0]=parseFloat(r.getElementsByTagName("scale")[0].firstChild.nodeValue)}if(r.getElementsByTagName("offset").length){x._scale_offset[1]=parseFloat(r.getElementsByTagName("offset")[0].firstChild.nodeValue)}}else{if(w=="Noise"){x=new superblaze_texture(q,w,"",null,d._scene);x.width=r.getElementsByTagName("width")[0].firstChild.nodeValue;x.height=r.getElementsByTagName("height")[0].firstChild.nodeValue;x.noiseseed=r.getElementsByTagName("noiseseed")[0].firstChild.nodeValue;x.noiserounds=r.getElementsByTagName("noiserounds")[0].firstChild.nodeValue;x.noisebrightness=parseFloat(r.getElementsByTagName("noisebrightness")[0].firstChild.nodeValue);x.noisecontrast=parseFloat(r.getElementsByTagName("noisecontrast")[0].firstChild.nodeValue);x.noisesaturation=parseFloat(r.getElementsByTagName("noisesaturation")[0].firstChild.nodeValue)}else{if(w=="Operation"){x=new superblaze_texture(q,w,"",null,d._scene);x.width=r.getElementsByTagName("width")[0].firstChild.nodeValue;x.height=r.getElementsByTagName("height")[0].firstChild.nodeValue;x.operation=r.getElementsByTagName("operation")[0].firstChild.nodeValue;if(r.getElementsByTagName("tex1").length){x.tex1name=r.getElementsByTagName("tex1")[0].firstChild.nodeValue}if(r.getElementsByTagName("tex2").length){x.tex2name=r.getElementsByTagName("tex2")[0].firstChild.nodeValue}if(r.getElementsByTagName("tex3").length){x.tex3name=r.getElementsByTagName("tex3")[0].firstChild.nodeValue}}else{console.log("Image Type "+w+" unsupported for image "+q)}}}}}var n=p.getElementsByTagName("viewcamera");if(n.length>0){d._scene._backgroundColor=superblaze_intToFloatArray(n[0].getElementsByTagName("background")[0].firstChild.nodeValue);d._scene.setBackgroundTransparent(d._scene._backgroundTransparent);if(n[0].getElementsByTagName("fovy").length){d._scene.fovy=parseFloat(n[0].getElementsByTagName("fovy")[0].firstChild.nodeValue)}if(n[0].getElementsByTagName("matrix").length){d._scene._initialViewMatrix=n[0].getElementsByTagName("matrix")[0].firstChild.nodeValue.split(" ");d._scene._initialNavMatrix=d._scene._initialViewMatrix.slice(0)}}var o=p.getElementsByTagName("material");for(var t=0;t<o.length;t++){var h=o[t];var j=(h.getElementsByTagName("name").length)?(h.getElementsByTagName("name")[0].firstChild.nodeValue):null;var u=new superblaze_material(j,d._scene);u.type=h.getElementsByTagName("type")[0].firstChild.nodeValue;if(u.type=="Standard"){var k;if(h.getElementsByTagName("diffuseenv").length){k=h.getElementsByTagName("diffuseenv")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_DIFFUSEENV)}}if(h.getElementsByTagName("diffusetexture").length){k=h.getElementsByTagName("diffusetexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_DIFFUSETEX)}}u.diffusecolor=h.getElementsByTagName("diffusecolour")[0].firstChild.nodeValue.split(",");u.diffuseuserscale=parseFloat(h.getElementsByTagName("diffuseuserscale")[0].firstChild.nodeValue);k=h.getElementsByTagName("glossyenv")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_GLOSSYENV)}if(h.getElementsByTagName("glossytexture").length){k=h.getElementsByTagName("glossytexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_GLOSSYTEX)}}u.glossycolor=h.getElementsByTagName("glossycolour")[0].firstChild.nodeValue.split(",");u.glossyuserscale=parseFloat(h.getElementsByTagName("glossyuserscale")[0].firstChild.nodeValue);k=h.getElementsByTagName("specularenv")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_SPECULARENV)}if(h.getElementsByTagName("speculartexture").length){k=h.getElementsByTagName("speculartexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_SPECULARTEX)}}u.specularcolor=h.getElementsByTagName("specularcolour")[0].firstChild.nodeValue.split(",");u.specularuserscale=parseFloat(h.getElementsByTagName("specularuserscale")[0].firstChild.nodeValue);if(h.getElementsByTagName("degree_0_specular").length){u.fresnel=1;u.degree_0_specular=parseFloat(h.getElementsByTagName("degree_0_specular")[0].firstChild.nodeValue);if(h.getElementsByTagName("degree_90_specular").length){u.degree_90_specular=parseFloat(h.getElementsByTagName("degree_90_specular")[0].firstChild.nodeValue)}if(h.getElementsByTagName("brdf_curve").length){u.brdf_curve=parseFloat(h.getElementsByTagName("brdf_curve")[0].firstChild.nodeValue)}}if(h.getElementsByTagName("alphatexture").length){k=h.getElementsByTagName("alphatexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_ALPHATEX)}}if(h.getElementsByTagName("bumptexture").length){k=h.getElementsByTagName("bumptexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_BUMPTEX)}u.bumpuserscale=parseFloat(h.getElementsByTagName("bumpuserscale")[0].firstChild.nodeValue)}u.invertreflectiony=parseFloat(h.getElementsByTagName("invertreflectiony")[0].firstChild.nodeValue);u.diffusecolor[0]*=u.diffuseuserscale;u.diffusecolor[1]*=u.diffuseuserscale;u.diffusecolor[2]*=u.diffuseuserscale;u.glossycolor[0]*=u.glossyuserscale;u.glossycolor[1]*=u.glossyuserscale;u.glossycolor[2]*=u.glossyuserscale;u.specularcolor[0]*=u.specularuserscale;u.specularcolor[1]*=u.specularuserscale;u.specularcolor[2]*=u.specularuserscale}else{if(u.type=="Glass"){var k=h.getElementsByTagName("specularenv")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_SPECULARENV)}if(h.getElementsByTagName("speculartexture").length){k=h.getElementsByTagName("speculartexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_SPECULARTEX)}}u.specularcolor=h.getElementsByTagName("specularcolour")[0].firstChild.nodeValue.split(",");u.specularuserscale=parseFloat(h.getElementsByTagName("specularuserscale")[0].firstChild.nodeValue);if(h.getElementsByTagName("degree_0_specular").length){u.degree_0_specular=parseFloat(h.getElementsByTagName("degree_0_specular")[0].firstChild.nodeValue);if(h.getElementsByTagName("degree_90_specular").length){u.degree_90_specular=parseFloat(h.getElementsByTagName("degree_90_specular")[0].firstChild.nodeValue)}if(h.getElementsByTagName("brdf_curve").length){u.brdf_curve=parseFloat(h.getElementsByTagName("brdf_curve")[0].firstChild.nodeValue)}}if(h.getElementsByTagName("bumptexture").length){k=h.getElementsByTagName("bumptexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_BUMPTEX)}u.bumpuserscale=parseFloat(h.getElementsByTagName("bumpuserscale")[0].firstChild.nodeValue)}if(h.getElementsByTagName("basetexture").length){k=h.getElementsByTagName("basetexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_BASETEX)}}u.basecolor=h.getElementsByTagName("basecolour")[0].firstChild.nodeValue.split(",");u.baseuserscale=parseFloat(h.getElementsByTagName("baseuserscale")[0].firstChild.nodeValue);u.specularcolor[0]*=u.specularuserscale;u.specularcolor[1]*=u.specularuserscale;u.specularcolor[2]*=u.specularuserscale;u.basecolor[0]*=u.baseuserscale;u.basecolor[1]*=u.baseuserscale;u.basecolor[2]*=u.baseuserscale}else{if(u.type=="Ambient"){if(h.getElementsByTagName("diffusetexture").length){var k=h.getElementsByTagName("diffusetexture")[0].firstChild.nodeValue;if(typeof(d._scene._Texture_ref[k])!="undefined"){u.setTexture(d._scene._Texture_ref[k],TEXTURE_MAP_DIFFUSETEX)}}u.diffusecolor=h.getElementsByTagName("diffusecolour")[0].firstChild.nodeValue.split(",");u.diffuseuserscale=parseFloat(h.getElementsByTagName("diffuseuserscale")[0].firstChild.nodeValue);u.diffusecolor[0]*=u.diffuseuserscale;u.diffusecolor[1]*=u.diffuseuserscale;u.diffusecolor[2]*=u.diffuseuserscale}else{console.log("Material "+j+" of Type "+u.type+" is not supported")}}}}d._scene.name="root";d._scene.children=[];var s=p.getElementsByTagName("root");d._scene.recurseParseSceneNode(d._scene,s[0]);var m=Math.sqrt(d._scene._bbmax[0]*d._scene._bbmax[0]+d._scene._bbmax[1]*d._scene._bbmax[1]+d._scene._bbmax[2]*d._scene._bbmax[2]);var l=Math.sqrt(d._scene._bbmin[0]*d._scene._bbmin[0]+d._scene._bbmin[1]*d._scene._bbmin[1]+d._scene._bbmin[2]*d._scene._bbmin[2]);d._scene.sceneRadius=(m>l)?m:l;d._scene.o_matrix=superblaze_identity.slice(0);d._scene.prepareTexId=d._scene._TextureObjs.length;d._scene._totaljobs+=d._scene._TextureObjs.length;d._scene._outstandingjobs--;d._scene._projectparsed=true};d.send("");return this};superblaze_scene.prototype.setBackgroundTransparent=function(a){this._backgroundTransparent=!!a;if(!this._backgroundTransparent){this.gl.clearColor(this._backgroundColor[0],this._backgroundColor[1],this._backgroundColor[2],1)}else{this.gl.clearColor(0,0,0,0)}};superblaze_scene.prototype.resetCounts=function(){this._refineCount=-1;this._aapasses=1};var superblazescene=null;superblaze_scene.prototype.start=function(){if(superblazescene==null){superblazescene=this}if(superblazescene._started){return}if(superblazescene._outstandingjobs>0){setTimeout(superblazescene.start,100);return}superblazescene.recurseEnableSceneNode(true,superblazescene);superblazescene.resetCounts();superblazescene.initTextureFramebuffer();for(var a=0;a<superblazescene._TextureObjs.length;a++){superblazescene._TextureObjs[a].startFileDownloads()}superblazescene._started=true};superblaze_scene.prototype.stop=function(){for(var a=0;a<this._Materials.length;a++){this._Materials[a].unload()}for(var a=0;a<this._TextureObjs.length;a++){this._TextureObjs[a].unload()}this._Images=[];this.recurseEnableSceneNode(false,this);this.unloadTextureFramebuffer();this._started=false};superblaze_scene.prototype.recurseEnableSceneNode=function(c,d){if(typeof(d.children)!="undefined"){for(var b=0;b<d.children.length;b++){var a=d.children[b];if(a.mesh!=null){if(c){a.mesh.loadToCard(this)}else{a.mesh.unload(this)}}this.recurseEnableSceneNode(c,a)}}};superblaze_scene.prototype.recurseParseSceneNode=function(c,e){for(var d=0;d<e.childNodes.length;d++){var f=e.childNodes[d];if(f.tagName=="geometry_file"){var b=f.childNodes[0].nodeValue;if(typeof(mapMeshFiles)=="undefined"){mapMeshFiles=[]}if(typeof(mapMeshFiles[b])=="undefined"){mapMeshFiles[b]=this.loadMesh(b)}c.mesh=mapMeshFiles[b]}else{if(f.tagName=="object"){var a=new Object();a.matrix=superblaze_identity;a.children=[];a.mesh=null;a.visible=1;c.children.push(a);this.recurseParseSceneNode(a,f)}else{if(f.tagName=="name"){if(typeof(f.childNodes[0])!="undefined"){c.name=f.childNodes[0].nodeValue}}else{if(f.tagName=="matrix"){c.matrix=f.childNodes[0].nodeValue.split(" ")}else{if(f.tagName=="visible"){c.visible=f.childNodes[0].nodeValue}else{if(f.tagName=="anim"){c.anim=new superblaze_anim();this.loadAnim(c,f)}}}}}}}};superblaze_scene.prototype.loadAnim=function(n,a){for(var i=0;i<a.childNodes.length;i++){var o=a.childNodes[i];if((o.tagName=="translation")||(o.tagName=="rotation")||(o.tagName=="scale")){var d=new Object();d._type=o.tagName;d._angle=0;n.anim.transforms.push(d);for(var g=0;g<o.childNodes.length;g++){var p=o.childNodes[g];if(p.tagName=="x"){d.x=parseFloat(p.childNodes[0].nodeValue)}else{if(p.tagName=="y"){d.y=parseFloat(p.childNodes[0].nodeValue)}else{if(p.tagName=="z"){d.z=parseFloat(p.childNodes[0].nodeValue)}else{if(p.tagName=="curve"){var c=new Object();c._keys=[];n.anim.curves.push(c);c._transformidx=n.anim.transforms.length-1;for(var f=0;f<p.childNodes.length;f++){var b=p.childNodes[f];if(b.tagName=="name"){c._name=b.childNodes[0].nodeValue}else{if(b.tagName=="qualifier"){c._qualifier=b.childNodes[0].nodeValue}else{if(b.tagName=="preInfinity"){c._preInfinity=parseInt(b.childNodes[0].nodeValue)}else{if(b.tagName=="postInfinity"){c._postInfinity=parseInt(b.childNodes[0].nodeValue)}else{if(b.tagName=="is2DCurveEvaluation"){c._is2DCurveEvaluation=parseInt(b.childNodes[0].nodeValue)}else{if(b.tagName=="key"){var q=new Object();q._inTangent=Array();q._outTangent=Array();c._keys.push(q);for(var e=0;e<b.childNodes.length;e++){var h=b.childNodes[e];if(h.tagName=="input"){q._input=parseFloat(h.childNodes[0].nodeValue)}else{if(h.tagName=="output"){q._output=parseFloat(h.childNodes[0].nodeValue)}else{if(h.tagName=="interpolation"){q._interpolation=parseInt(h.childNodes[0].nodeValue)}else{if(h.tagName=="inTangentX"){q._inTangent[0]=parseFloat(h.childNodes[0].nodeValue)}else{if(h.tagName=="inTangentY"){q._inTangent[1]=parseFloat(h.childNodes[0].nodeValue)}else{if(h.tagName=="outTangentX"){q._outTangent[0]=parseFloat(h.childNodes[0].nodeValue)}else{if(h.tagName=="outTangentY"){q._outTangent[1]=parseFloat(h.childNodes[0].nodeValue)}}}}}}}}}}}}}}}}}}}}}}};superblaze_scene.prototype.loadMesh=function(a,c){var d=new superblaze_object();d._scene=this;var b=new XMLHttpRequest();b.open("GET",this.urlRoot+a,true);b.overrideMimeType("text/plain; charset=x-user-defined");b.onload=function(ad){try{if(b.status==200){var af=new BinaryReader(b.response);d.doublesided=false;var aa=af.readUInt32();var k=af.readUInt32();var r=af.readUInt32();var S=af.readFloat();var x=af.readFloat();var j=af.readFloat();var V=af.readFloat();var y=af.readFloat();var n=af.readFloat();var u=0,t=0,H=1,F=1;if(aa>=6){u=af.readFloat();t=af.readFloat();H=af.readFloat();F=af.readFloat()}var w=1/65535;var p=(V-S)*w;var m=(y-x)*w;var l=(n-j)*w;var ac=(H-u)*w;var ab=(F-t)*w;var ae=new Array(k);var z=new Array(k);var U=new Array(k);for(var X=0;X<k;X++){var h=af.readUInt16();var g=af.readUInt16();var f=af.readUInt16();var Q=af.readUInt16();var P=af.readUInt16();var O=af.readUInt16();var C=af.readUInt16();var A=af.readUInt16();ae[X]=[S+p*h,x+m*g,j+l*f];z[X]=[((Q*w)*2)-1,((P*w)*2)-1,((O*w)*2)-1];U[X]=[u+C*ac,t+A*ab];for(var Z=0;Z<3;Z++){if(ae[X][Z]>d._scene._bbmax[Z]){d._scene._bbmax[Z]=ae[X][Z]}if(ae[X][Z]<d._scene._bbmin[Z]){d._scene._bbmin[Z]=ae[X][Z]}}}if(k<65535){d.addPoint(ae);d.addNormal(z);d.addUV(U);var Y=0;for(var s=0;s<r;s++){var W=af.readUInt32();Y+=W;var q=af.readUInt32();if(q>2147483648){q-=2147483648;d.doublesided=true}if(q<d._scene._Materials.length){var B=d._scene._Materials[q];d.setFaceMaterial(B)}for(var T=0;T<W;T++){var L=af.readUInt32();var K=af.readUInt32();var G=af.readUInt32();d.addFace([L,K,G])}}d.CalcSurfTangents();d.compile(d._scene);d.subobjs=null}else{d.subobjs=[];var s=0;var D=new Array(k);for(var N=0;N<r;N++){var R=af.readUInt32();var q=af.readUInt32();if(q>2147483648){q-=2147483648;d.doublesided=true}var B=d._scene._Materials[q];var E=null;for(var T=0;T<R;T++){if(E==null||E.mesh._bigmesh_numverts>65530){E=new Object();E.children=[];E.mesh=new superblaze_object();d.subobjs.push(E);E.mesh.setFaceMaterial(B);for(var J=0;J<k;J++){D[J]=-1}E.mesh._bigmesh_numverts=0}var I=[];for(var M=0;M<3;M++){var o=af.readUInt32();if(D[o]==-1){E.mesh.addPoint(ae[o]);E.mesh.addNormal(z[o]);E.mesh.addUV(U[o]);D[o]=E.mesh._bigmesh_numverts;E.mesh._bigmesh_numverts++}I[M]=D[o]}E.mesh.addFace(I)}}for(var v=0;v<d.subobjs.length;v++){d.subobjs[v].mesh.CalcSurfTangents();d.subobjs[v].mesh.compile(d._scene)}}}}catch(ad){console.log("***ERROR: Loading Mesh '"+a+"' "+ad)}d._scene._outstandingjobs--};this._outstandingjobs++;this._totaljobs++;b.send("");return d};superblaze_scene.prototype.forceAA=function(a){this._bAllowDirectRender=!a};superblaze_scene.prototype.prepare=function(){if(this._prepared){return true}if(this.prepareTexId==0){this._prepared=true;return true}this._TextureObjs[--this.prepareTexId].refresh();return false};var now=(function(){var a=window.performance||{};a.now=(function(){return a.now||a.webkitNow||a.msNow||a.oNow||a.mozNow||function(){return new Date().getTime()}})();return a.now()});superblaze_scene.prototype.checkaapasses=function(a){if(a<50){this._aapasses++}else{if(a>100){this._aapasses--}}if(this._aapasses<1){this._aapasses=1}else{if(this._aapasses>5){this._aapasses=5}}};superblaze_scene.prototype.draw=function(){if(!this._started){return false}if(this._outstandingjobs>0){return false}if(!this.prepare()){return false}var e=now();this.camPos=[parseFloat(this.matView[12]),parseFloat(this.matView[13]),parseFloat(this.matView[14])];var g=[this.matView[12]-this.matView[8],this.matView[13]-this.matView[9],this.matView[14]-this.matView[10]];var d=[this.matView[4],this.matView[5],this.matView[6]];this.mv_matrix=superblaze_lookat(this.camPos,g,d,g_navPan);var a=superblaze_length(this.camPos);var c=a-this.sceneRadius;if(c<_zNearMin){c=_zNearMin}var i=a+this.sceneRadius;this.p_matrix=superblaze_perspective(this.fovy,this.viewwidth/this.viewheight,c,i);this._animRequiresClear=false;this._animEval=true;this.mvp_matrix=MatrixMultiply(this.mv_matrix,this.p_matrix);if((!!mdown)||(!!g_navGotoPosActive)){this._refineCount=-1}if(this._bAllowDirectRender&&this._refineCount==-1){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.gl.viewport(0,0,this.viewwidth,this.viewheight);this.renderScene();this._animEval=false;this._refineCount++}else{for(var j=0;j<this._aapasses&&this._refineCount<64;j++){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.rttFramebuffer);this.gl.viewport(0,0,this.viewwidth,this.viewheight);this.renderScene();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.rttAccumFramebufferCurrent);this.gl.viewport(0,0,this.rttwidth,this.rttheight);var b=(this._bAllowDirectRender)?1/(1+this._refineCount):1/(2+this._refineCount);this.renderRefinement(this.rttTexture,this.rttAccumTextureSource,b,false);if(this.rttAccumFramebufferCurrent==this.rttAccumFramebufferA){this.rttAccumTextureSource=this.rttAccumTextureA;this.rttAccumFramebufferCurrent=this.rttAccumFramebufferB}else{this.rttAccumTextureSource=this.rttAccumTextureB;this.rttAccumFramebufferCurrent=this.rttAccumFramebufferA}this._animEval=false;this._refineCount++}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.gl.viewport(0,0,this.viewwidth,this.viewheight);this.renderRefinement(this.rttAccumTextureSource,this.rttAccumTextureSource,1,true)}for(var f=1;f<4;f++){this.renderUIAtDepth(f,this)}if(this._animRequiresClear){this.clearRefine()}this.gl.finish();if(this._refineCount<64){var h=now();this.checkaapasses(h-e)}return true};superblaze_scene.prototype.setViewMatrix=function(a){this.matView=a};superblaze_scene.prototype.setModelMatrix=function(a){this.mHierModel=a};var g_jitx=[0,-0.158,0.474,0.158,-0.474,0.288,0.2726,-0.3452,0.0142,-0.2662,0.2856,0.0474,-0.1864,0.269,-0.4118,-0.0242,0.465,0.1062,0.1878,0.4154,-0.1586,-0.1632,0.167,-0.3764,0.1262,-0.4848,-0.2954,0.0754,-0.0934,0.4202,0.3356,-0.0412,-0.1342,-0.143,0.1898,-0.0022,0.317,0.141,-0.0678,-0.247,-0.2828,-0.4078,-0.255,0.3836,0.1706,0.3054,-0.3808,-0.027,0.0632,0.1186,-0.3512,-0.2856,0.2026,0.3746,0.0104,0.1048,-0.1902,-0.405,-0.4704,0.2658,-0.1878,0.1958,0.0788,-0.1592];var g_jity=[0,0.474,0.158,-0.474,-0.158,0.408,-0.4032,-0.349,0.2998,0.1178,0.0962,-0.2556,-0.1684,-0.1744,0.2644,0.4994,0.1824,-0.4816,0.252,-0.2752,0.259,-0.3416,-0.0332,-0.182,0.423,0.1166,-0.0384,0.148,0.1172,0.038,0.2626,-0.1398,0.3972,-0.0322,-0.2896,-0.3874,-0.0382,-0.1612,-0.2716,-0.4302,0.2764,0.0216,-0.2644,-0.166,0.0866,-0.279,0.1624,0.2072,-0.0874,-0.3736,0.3542,-0.1396,0.3532,0.1418,0.398,0.33,0.0662,-0.0896,-0.1604,0.1986,0.171,-0.4568,0.052,-0.4574];var g_nRandomIdx=0;function HMXRandom(a){var b=a[g_nRandomIdx++];if(g_nRandomIdx>a.length-1){g_nRandomIdx=0}return b}superblaze_scene.prototype.renderScene=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);if(this._refineCount>0){this._jitter[0]=3*(HMXRandom(g_jitx));this._jitter[1]=3*(HMXRandom(g_jity));this._jitter[0]/=this.viewwidth;this._jitter[1]/=this.viewheight}else{this._jitter[1]=this._jitter[0]=0;g_nRandomIdx=0}this.renderObject(this,this.mHierModel,false);this.renderObject(this,this.mHierModel,true)};superblaze_scene.prototype.renderObject=function(a,c,b){if(a.visible==0){return}var e,d;if(typeof(a.anim)!="undefined"&&!b&&this._refineCount<=0&&this._animEval){if(a.anim.step()){evaluateSceneNode(a,a.anim);this._animRequiresClear=true}}if(typeof(a.matrix)!="undefined"){c=MatrixMultiply(a.matrix,c)}var m=a.mesh;if(m!=null){if(m.subobjs!=null){for(var l=0;l<m.subobjs.length;l++){this.renderObject(m.subobjs[l],c,b)}return}var n=MatrixDet(c);if(n<0){this.gl.cullFace(this.gl.FRONT)}else{this.gl.cullFace(this.gl.BACK)}if(m.doublesided){this.gl.disable(this.gl.CULL_FACE)}var k=0;for(e in m.compiled.elements){var o=this._Materials[e];var h=0;var f=false;var d;for(d in m.compiled.elements[e]){f=false;var g=m.compiled.elements[e][d].length;h+=g;if(m.segment_state[d]){}else{if(h>g){k+=g*2;h-=g;if(this.CanRender(o,b)){o.use(0);o.shader[0].setVector("uCamPos",this.camPos);o.shader[0].setMatrix("uMVMatrix",this.mv_matrix);o.shader[0].setMatrix("uPMatrix",this.p_matrix);o.shader[0].setMatrix("uOMatrix",c);o.shader[0].setFloat2("jitter",this._jitter);o.bindObject(m,0);this.gl.drawElements(this.gl.TRIANGLES,h,this.gl.UNSIGNED_SHORT,k)}k+=h*2;h=0;f=true}else{k+=h*2;h=0}}}if(!f&&m.segment_state[d]){if(this.CanRender(o,b)){o.use(0);o.shader[0].setVector("uCamPos",this.camPos);o.shader[0].setMatrix("uMVMatrix",this.mv_matrix);o.shader[0].setMatrix("uPMatrix",this.p_matrix);o.shader[0].setMatrix("uOMatrix",c);o.shader[0].setFloat2("jitter",this._jitter);o.bindObject(m,0);this.gl.drawElements(this.gl.TRIANGLES,h,this.gl.UNSIGNED_SHORT,k)}k+=h*2}}if(m.doublesided){this.gl.enable(this.gl.CULL_FACE)}if(n<0){this.gl.cullFace(this.gl.BACK)}}if(typeof(a.children)!="undefined"){for(d=0;d<a.children.length;d++){this.renderObject(a.children[d],c,b)}}};superblaze_scene.prototype.CanRender=function(a,b){if(b){if(typeof(a.textures[TEXTURE_MAP_ALPHATEX])!="undefined"||a.type=="Glass"){this.gl.enable(this.gl.BLEND);return true}}else{if(typeof(a.textures[TEXTURE_MAP_ALPHATEX])=="undefined"&&a.type!="Glass"){this.gl.disable(this.gl.BLEND);return true}}return false};superblaze_scene.prototype.initTextureFramebuffer=function(){this.rttwidth=1024;this.rttheight=1024;if(this.viewwidth>this.rttwidth||this.viewheight>this.rttheight){this.rttwidth=2048;this.rttheight=2048}this.rttFramebuffer=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.rttFramebuffer);this.rttTexture=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,this.rttTexture);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.rttwidth,this.rttheight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);this.rttRenderBuffer=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.rttRenderBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.rttwidth,this.rttheight);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.rttTexture,0);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.rttRenderBuffer);this.rttAccumFramebufferA=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.rttAccumFramebufferA);this.rttAccumTextureA=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,this.rttAccumTextureA);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.rttwidth,this.rttheight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.rttAccumTextureA,0);this.rttAccumFramebufferB=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.rttAccumFramebufferB);this.rttAccumTextureB=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,this.rttAccumTextureB);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.rttwidth,this.rttheight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.rttAccumTextureB,0);this.rttAccumTextureSource=this.rttAccumTextureB;this.rttAccumFramebufferCurrent=this.rttAccumFramebufferA;this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};superblaze_scene.prototype.unloadTextureFramebuffer=function(){this.gl.deleteTexture(this.rttTexture);this.rttTexture=null;this.gl.deleteFramebuffer(this.rttFramebuffer);this.rttFramebuffer=null;this.gl.deleteRenderbuffer(this.rttRenderBuffer);this.rttRenderBuffer=null;this.gl.deleteTexture(this.rttAccumTextureA);this.rttAccumTextureA=null;this.gl.deleteTexture(this.rttAccumTextureB);this.rttAccumTextureB=null;this.gl.deleteFramebuffer(this.rttAccumFramebufferA);this.rttAccumFramebufferA=null;this.gl.deleteFramebuffer(this.rttAccumFramebufferB);this.rttAccumFramebufferB=null};superblaze_scene.prototype.loadRefinementShader=function(){var b=superblaze_compileShader(this.gl,shaderSuperBlaze_Refinevs,"x-shader/x-vertex");var a=superblaze_compileShader(this.gl,shaderSuperBlaze_Refinefs,"x-shader/x-fragment");this._programRefine=this.gl.createProgram();this.gl.attachShader(this._programRefine,b);this.gl.attachShader(this._programRefine,a);this.gl.linkProgram(this._programRefine);if(!this.gl.getProgramParameter(this._programRefine,this.gl.LINK_STATUS)){console.log("***Could not initialise refinement shader")}else{this.ATTRIB_VERTEX=this.gl.getAttribLocation(this._programRefine,"a_position");this.ATTRIB_TEX0=this.gl.getAttribLocation(this._programRefine,"a_tex0");this._uniformsRefine=Array();this._uniformsRefine[0]=this.gl.getUniformLocation(this._programRefine,"logoTex");this._uniformsRefine[1]=this.gl.getUniformLocation(this._programRefine,"solidAlpha");this._uniformsRefine[2]=this.gl.getUniformLocation(this._programRefine,"solidColor");this._uniformsRefine[3]=this.gl.getUniformLocation(this._programRefine,"prevTex")}};superblaze_scene.prototype.renderRefinement=function(c,e,h,d){if(typeof(this._programRefine)=="undefined"){this.loadRefinementShader()}if(h==1){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}this.gl.useProgram(this._programRefine);this.gl.uniform1i(this._uniformsRefine[0],0);this.gl.uniform1f(this._uniformsRefine[1],h);this.gl.uniform1i(this._uniformsRefine[2],1);this.gl.uniform1i(this._uniformsRefine[3],1);if(typeof(this.buffProgressRefine)=="undefined"){var a=[-1,-1,1,-1,-1,1,1,1];this.buffProgressRefine=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffProgressRefine);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(a),this.gl.STATIC_DRAW);this.buffProgressRefine.itemSize=2;this.buffProgressRefine.numItems=4}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffProgressRefine);this.gl.vertexAttribPointer(this.ATTRIB_VERTEX,2,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.ATTRIB_VERTEX);if(d){if(typeof(this.buffProgressRefineScaledCoords)=="undefined"){var g=this.viewwidth/this.rttwidth;var f=this.viewheight/this.rttheight;var b=[0,0,g,0,0,f,g,f];this.buffProgressRefineScaledCoords=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffProgressRefineScaledCoords);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(b),this.gl.STATIC_DRAW);this.buffProgressRefineScaledCoords.itemSize=2;this.buffProgressRefineScaledCoords.numItems=4}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffProgressRefineScaledCoords)}else{if(typeof(this.buffProgressRefineCoords)=="undefined"){var g=(d)?(this.viewwidth/this.rttwidth):1;var f=(d)?(this.viewheight/this.rttheight):1;var b=[0,0,1,0,0,1,1,1];this.buffProgressRefineCoords=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffProgressRefineCoords);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(b),this.gl.STATIC_DRAW);this.buffProgressRefineCoords.itemSize=2;this.buffProgressRefineCoords.numItems=4}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffProgressRefineCoords)}this.gl.vertexAttribPointer(this.ATTRIB_TEX0,2,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.ATTRIB_TEX0);this.gl.disable(this.gl.DEPTH_TEST);this.gl.disable(this.gl.BLEND);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,c);this.gl.activeTexture(this.gl.TEXTURE1);this.gl.bindTexture(this.gl.TEXTURE_2D,e);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.buffProgressRefine.numItems);this.gl.enable(this.gl.DEPTH_TEST)};superblaze_scene.prototype.clearRefine=function(){this._refineCount=-1};superblaze_scene.prototype.gotoPos=function(d,b,a,g,c,f,e){NavStartGotoPos(d,b,a,g,c,f,e);this.clearRefine()};superblaze_scene.prototype.gotoNamedPos=function(a,b){this.gotoPos(a.xang,a.yang,a.xpan,a.ypan,a.dolly,b)};superblaze_scene.prototype.getViewMatrix=function(){return this.matView};superblaze_scene.prototype.getInstanceByName=function(c,d){if(d.name==c){return d}if(typeof(d.children)!="undefined"){for(var b=0;b<d.children.length;b++){var a=this.getInstanceByName(c,d.children[b]);if(a!=null){return a}}}return null};superblaze_scene.prototype.replaceMaterial=function(h,g,f){var c;var b=0;var e=h.mesh;if(e!=null){if(e.subobjs!=null){for(var d=0;d<e.subobjs.length;d++){var j=false;for(c=0;c<e.subobjs[d].faces.length;c++){if(e.subobjs[d].faces[c].material==g.material_id){e.subobjs[d].faces[c].material=f.material_id;j=true}}if(j){e.subobjs[d].compile(this);b++}}}else{var j=false;for(c=0;c<e.faces.length;c++){if(e.faces[c].material==g.material_id){e.faces[c].material=f.material_id;j=true}}if(j){e.compile(this);b++}}}for(var a=0;a<h.children.length;a++){b+=this.replaceMaterial(h.children[a],g,f)}return b};sceneui_sprite=function(a){this.texture=null;this.x=0;this.y=0;this.offsetx=0;this.offsety=0;this.depth=1;this.visible=true;this.alpha=1};sceneui_sprite.prototype.renderAtDepth=function(d,f){if(!this.visible){return}if(this.depth!=d){return}var b=f._Images[this.texture.tex_id];f.gl.uniform1i(f._uniformsRefine[0],0);f.gl.uniform1f(f._uniformsRefine[1],this.alpha);f.gl.uniform1i(f._uniformsRefine[2],3);f.gl.uniform1i(f._uniformsRefine[3],0);this.texture.filtering=f.gl.NEAREST;this.texture.use(f.gl.TEXTURE0);var e=this.x+this.offsetx;var a=this.y+this.offsety;var c=b.width/f.viewwidth;var g=b.height/f.viewheight;var i=[e-c,a-g,e+c,a-g,e-c,a+g,e+c,a+g];if(typeof(this.buffVertsBtn)=="undefined"){this.buffVertsBtn=f.gl.createBuffer()}f.gl.bindBuffer(f.gl.ARRAY_BUFFER,this.buffVertsBtn);f.gl.bufferData(f.gl.ARRAY_BUFFER,new Float32Array(i),f.gl.STATIC_DRAW);f.gl.vertexAttribPointer(f.ATTRIB_VERTEX,2,f.gl.FLOAT,false,0,0);f.gl.enableVertexAttribArray(f.ATTRIB_VERTEX);var h=[0,0,1,0,0,1,1,1];if(typeof(this.buffTexsBtn)=="undefined"){this.buffTexsBtn=f.gl.createBuffer()}f.gl.bindBuffer(f.gl.ARRAY_BUFFER,this.buffTexsBtn);f.gl.bufferData(f.gl.ARRAY_BUFFER,new Float32Array(h),f.gl.STATIC_DRAW);f.gl.vertexAttribPointer(f.ATTRIB_TEX0,2,f.gl.FLOAT,false,0,0);f.gl.enableVertexAttribArray(f.ATTRIB_TEX0);f.gl.drawArrays(f.gl.TRIANGLE_STRIP,0,4)};sceneui_sprite.prototype.onTouch=function(j,f){if(!this.visible){return null}var e=j[0];var a=(f.viewheight)-j[1];var i=0.5*(this.x+this.offsetx+1)*f.viewwidth;var h=0.5*(this.y+this.offsety+1)*f.viewheight;var b=f._Images[this.texture.tex_id];var d=0.5*b.width;var g=0.5*b.height;xMin=i-d;yMin=h-g;xMax=i+d;yMax=h+g;if(e>=xMin&&e<=xMax&&a>=yMin&&a<=yMax){var c=new Object();c.depth=this.depth;return c}return null};superblaze_scene.prototype.onClick=function(mousePos,mouseButton){var highestDepthTouched=-2;var spriteTouched=null;for(var i=0;i<this.uiSprites.length;i++){var spriteCheck=this.uiSprites[i].onTouch(mousePos,this);if(spriteCheck!=null&&spriteCheck.depth>highestDepthTouched){spriteTouched=this.uiSprites[i];highestDepthTouched=spriteCheck.depth}}if(spriteTouched!=null&&typeof(spriteTouched.onTouchAction)!="undefined"){eval(spriteTouched.onTouchAction+"(["+mousePos+"], "+mouseButton+");");return true}return false};superblaze_scene.prototype.renderUIAtDepth=function(b){if(typeof(this._programRefine)=="undefined"){this.loadRefinementShader()}this.gl.useProgram(this._programRefine);this.gl.disable(this.gl.DEPTH_TEST);this.gl.enable(this.gl.BLEND);this.gl.activeTexture(this.gl.TEXTURE0);for(var a=0;a<this.uiSprites.length;a++){this.uiSprites[a].renderAtDepth(b,this)}this.gl.disable(this.gl.BLEND);this.gl.enable(this.gl.DEPTH_TEST)};superblaze_scene.prototype.createImage=function(c,a){var b=new superblaze_texture(c,"File",this.urlRoot+a,null,this);b.startFileDownloads();return b};superblaze_scene.prototype.getObjectLocation=function(b,c){var a=this.getInstanceByName(b,this);if(a==null){return null}if((!!c)&&a.mesh.bb){return[parseFloat(a.matrix[12])+0.5*(a.mesh.bb[1][0]+a.mesh.bb[0][0]),parseFloat(a.matrix[13])+0.5*(a.mesh.bb[1][1]+a.mesh.bb[0][1]),parseFloat(a.matrix[14])+0.5*(a.mesh.bb[1][2]+a.mesh.bb[0][2])]}return[a.matrix[12],a.matrix[13],a.matrix[14]]};superblaze_scene.prototype.getObjectNormal=function(b){var a=this.getInstanceByName(b,this);if(a==null||a.mesh==null){return null}var c=[a.mesh.point_normals[0][0],a.mesh.point_normals[0][1],a.mesh.point_normals[0][2],0];return PointTransform(c,a.matrix)};superblaze_scene.prototype.projectPoint=function(a){if(typeof(this.mvp_matrix)=="undefined"){return null}var c=[a[0],a[1],a[2],1];var b=PointTransform(c,this.mvp_matrix);b[0]/=b[3];b[1]/=b[3];b[2]/=b[3];b[3]=1;return b};superblaze_scene.prototype.placeImage=function(d,b,f,e,a){var c=new sceneui_sprite();if(c==null){return null}c.texture=d;c.x=b[0];c.y=b[1];c.depth=f;c.offsetx=e[0];c.offsety=e[1];c.onTouchAction=a;this.uiSprites.push(c);return c};superblaze_scene.prototype.imageSet=function(a,c,b){if(c=="position"){a.x=b[0];a.y=b[1]}else{a[c]=b}};superblaze_scene.prototype.pixelToScreen=function(c,b){var d=scene._Images[c.tex_id];var a=(b[0]/d.width)*(d.width/this.viewwidth)*2;var e=(b[1]/d.height)*(d.height/this.viewheight)*2;return[a,e]};superblaze_scene.prototype.getAnim=function(b){var a=this.getInstanceByName(b,this);if(a==null){return null}return a.anim};superblaze_scene.prototype.animIsPlaying=function(a){var b=this.getAnim(a);if(b==null){return false}return b.isPlaying()};superblaze_scene.prototype.animPosition=function(a){var b=this.getAnim(a);if(b==null){return 0}return b.position()};superblaze_scene.prototype.animPlay=function(a,b,e,d){var c=this.getAnim(a);if(c==null){return false}return c.play(b,e,d)};superblaze_scene.prototype.materialSet=function(d,c,b){var a=this._Material_ref[d];if(a==null){return false}a[c]=b;return true};superblaze_scene.prototype.instanceSet=function(b,d,c){var a=this.getInstanceByName(b,this);if(a==null){return false}a[d]=c;return true};superblaze_scene.prototype.instanceGet=function(b,c){var a=this.getInstanceByName(b,this);if(a==null){return null}return a[c]};superblaze_scene.prototype.setParam=function(b,a){if(b=="nav.enable"){g_navEnabled=a;return true}else{if(b=="nav.mode"){g_navMode=a;return true}else{if(b=="nav.decay"){g_navDecay=a;return true}else{if(b=="nav.speed"){g_navSpeed=a;return true}else{if(b=="nav.mindist"){g_navMinDolly=a;return true}else{if(b=="nav.maxdist"){g_navMaxDolly=a;return true}else{if(b=="nav.znearmin"){_zNearMin=a;return true}}}}}}}return false};superblaze_scene.prototype.getParam=function(b,a){if(b=="screen.width"){return this.viewwidth}else{if(b=="screen.height"){return this.viewheight}}if(b=="platform"){return"webgl"}};superblaze_scene.prototype.materialReplace=function(f,e){var b=this._Material_ref[f];if(b==null){return 0}var a=this._Material_ref[e];if(a==null){return 0}var d=this._Materials.indexOf(b);if(d==-1){return 0}var c=this._Materials.indexOf(a);if(c==-1){return 0}this._Materials[d]=a;this._Materials[c]=b;return 1};superblaze_scene.prototype.getOutstandingJobs=function(){return this._outstandingjobs+this.prepareTexId};superblaze_scene.prototype.getTotalJobs=function(){return this._totaljobs};